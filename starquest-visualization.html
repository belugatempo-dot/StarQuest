<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StarQuest - Interactive Codebase Guide</title>
<style>
  /* === DARK THEME (starry night) === */
  :root, [data-theme="dark"] {
    --bg: #0f172a;
    --bg-gradient: linear-gradient(170deg, #1e3a5f 0%, #0f172a 35%, #312e81 65%, #0f172a 100%);
    --card: rgba(75, 85, 160, 0.45);
    --accent: #FFD700;
    --accent2: #FBBF24;
    --accent3: #4F46E5;
    --accent4: #10B981;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --border: rgba(255, 255, 255, 0.15);
    --glow: rgba(255, 215, 0, 0.12);
    --nav-bg: rgba(15, 23, 42, 0.88);
    --node-fill: rgba(75, 85, 160, 0.5);
    --node-label: #ffffff;
    --node-sublabel: #94a3b8;
    --panel-shadow: rgba(0, 0, 0, 0.5);
    --conn-bg: rgba(255, 255, 255, 0.03);
    --danger: #EF4444;
  }
  /* === LIGHT THEME === */
  [data-theme="light"] {
    --bg: #f5f5fa;
    --bg-gradient: none;
    --card: #ffffff;
    --accent: #b8860b;
    --accent2: #d4a017;
    --accent3: #4338ca;
    --accent4: #16a34a;
    --text: #1a1a2e;
    --text-dim: #64748b;
    --border: #e2e8f0;
    --glow: rgba(184, 134, 11, 0.08);
    --nav-bg: rgba(245, 245, 250, 0.95);
    --node-fill: #ffffff;
    --node-label: #1a1a2e;
    --node-sublabel: #64748b;
    --panel-shadow: rgba(0, 0, 0, 0.1);
    --conn-bg: rgba(0, 0, 0, 0.03);
    --danger: #dc2626;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    background-image: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* === NAV === */
  nav {
    position: fixed; top: 0; left: 0; right: 0; z-index: 100;
    background: var(--nav-bg);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 2rem; height: 56px;
  }
  nav .logo {
    font-size: 1.2rem; font-weight: 700;
    color: var(--accent);
    text-shadow: 0 0 12px rgba(255,215,0,0.3);
    white-space: nowrap;
  }
  nav .tabs { display: flex; gap: 0.4rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
  nav .tabs button {
    background: none; border: none; color: var(--text-dim);
    padding: 0.45rem 0.9rem; cursor: pointer; border-radius: 8px;
    font-size: 0.88rem; transition: all 0.3s; white-space: nowrap;
  }
  nav .tabs button:hover { color: var(--text); background: rgba(255,255,255,0.06); }
  nav .tabs button.active {
    color: var(--accent); background: var(--glow);
    box-shadow: 0 0 12px rgba(255,215,0,0.08);
  }
  nav .nav-controls { display: flex; gap: 0.4rem; align-items: center; }
  nav .ctrl-btn {
    background: rgba(255,255,255,0.06); border: 1px solid var(--border);
    color: var(--text); padding: 0.35rem 0.7rem; border-radius: 6px;
    cursor: pointer; font-size: 0.82rem; transition: all 0.3s;
  }
  nav .ctrl-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* === MAIN === */
  main { margin-top: 56px; padding: 2rem; max-width: 1200px; margin-left: auto; margin-right: auto; position: relative; z-index: 1; }
  section { display: none; animation: fadeIn 0.4s ease; }
  section.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* === HERO (Story Mode) === */
  .hero {
    text-align: center; padding: 3rem 1rem 2rem;
    background: radial-gradient(ellipse at center, var(--glow) 0%, transparent 70%);
    border-radius: 20px; margin-bottom: 2.5rem;
  }
  .hero .mascot { font-size: 4rem; margin-bottom: 0.8rem; }
  .hero h1 { font-size: 2.4rem; margin-bottom: 0.8rem; color: var(--accent); }
  .hero .subtitle { color: var(--text-dim); font-size: 1.15rem; line-height: 1.8; max-width: 700px; margin: 0 auto; }

  /* === STORY TIMELINE === */
  .story-timeline { position: relative; padding-left: 3rem; max-width: 900px; margin: 0 auto; }
  .story-timeline::before {
    content: ''; position: absolute; left: 1rem; top: 0; bottom: 0;
    width: 3px; background: linear-gradient(to bottom, var(--accent), var(--accent3), var(--accent4));
    border-radius: 3px;
  }
  .story-step {
    position: relative; margin-bottom: 1.5rem;
    background: var(--card); border: 1px solid var(--border);
    border-radius: 14px; padding: 1.4rem 1.8rem;
    cursor: pointer; transition: all 0.3s;
  }
  .story-step:hover {
    border-color: var(--accent);
    box-shadow: 0 4px 20px rgba(255,215,0,0.08);
    transform: translateX(4px);
  }
  .story-step::before {
    content: attr(data-icon); position: absolute; left: -2.5rem; top: 1.4rem;
    font-size: 1.4rem; width: 2rem; text-align: center;
  }
  .story-step .step-num {
    display: inline-block; background: var(--glow); color: var(--accent);
    padding: 0.15rem 0.55rem; border-radius: 4px; font-size: 0.72rem;
    font-weight: 600; margin-bottom: 0.4rem; letter-spacing: 0.5px;
  }
  .story-step h3 { margin-bottom: 0.4rem; font-size: 1.05rem; }
  .story-step p { color: var(--text-dim); line-height: 1.7; font-size: 0.92rem; }
  .story-step .detail {
    display: none; margin-top: 0.8rem; padding-top: 0.8rem;
    border-top: 1px solid var(--border); color: var(--text); line-height: 1.8; font-size: 0.92rem;
    white-space: pre-line;
  }
  .story-step.expanded .detail { display: block; animation: fadeIn 0.3s; }

  /* === ARCHITECTURE === */
  .arch-container { display: flex; flex-direction: column; gap: 1.5rem; }
  .arch-diagram {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 14px; padding: 1.5rem; min-height: 380px;
    position: relative; overflow: hidden;
    box-shadow: 0 4px 24px rgba(0,0,0,0.2);
  }
  .arch-diagram svg { width: 100%; height: auto; }
  .arch-legend {
    display: flex; flex-wrap: wrap; gap: 1rem;
    padding: 0.8rem 1rem; background: var(--card); border-radius: 10px;
    border: 1px solid var(--border);
  }
  .arch-legend .legend-item {
    display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text);
  }
  .arch-legend .legend-dot { width: 12px; height: 12px; border-radius: 50%; box-shadow: 0 0 6px currentColor; }

  /* === COMPONENT NODES === */
  .node-group { cursor: pointer; transition: transform 0.2s; }
  .node-group:hover { transform: scale(1.05); }
  .node-group:hover .node-rect { stroke-width: 2.5; filter: brightness(1.2); }
  .node-rect { rx: 12; ry: 12; stroke-width: 2; transition: all 0.3s; }
  .node-label { fill: var(--node-label); font-size: 17px; font-weight: 600; text-anchor: middle; dominant-baseline: central; pointer-events: none; }
  .node-sublabel { fill: var(--node-sublabel); font-size: 12px; text-anchor: middle; dominant-baseline: central; pointer-events: none; }

  /* === FLOW ARROWS === */
  .flow-path { fill: none; stroke-width: 2; stroke-dasharray: 8 4; animation: flowDash 1.5s linear infinite; }
  @keyframes flowDash { to { stroke-dashoffset: -24; } }
  .flow-label { font-size: 11px; fill: var(--text-dim); text-anchor: middle; dominant-baseline: central; }
  .flow-particle { opacity: 0.8; }

  /* === INLINE DETAIL CARD === */
  .inline-detail {
    display: none; margin-top: 1rem;
    background: var(--card); border: 1px solid var(--accent);
    border-radius: 14px; padding: 1.5rem; position: relative;
    animation: slideDown 0.3s ease;
    box-shadow: 0 4px 24px rgba(255,215,0,0.08);
  }
  .inline-detail.open { display: block; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  .inline-detail .close-btn {
    position: absolute; top: 0.6rem; right: 0.8rem;
    background: none; border: none; color: var(--text-dim);
    font-size: 1.4rem; cursor: pointer; line-height: 1;
  }
  .inline-detail .close-btn:hover { color: var(--text); }
  .inline-detail h2 { margin-bottom: 0.4rem; color: var(--accent); font-size: 1.2rem; }
  .inline-detail .tag {
    display: inline-block; background: var(--glow); color: var(--accent);
    padding: 0.15rem 0.5rem; border-radius: 4px; font-size: 0.75rem;
    margin-right: 0.25rem; margin-bottom: 0.25rem;
  }
  .inline-detail .desc { color: var(--text-dim); line-height: 1.8; margin: 0.8rem 0; font-size: 0.92rem; }
  .inline-detail .connections { margin-top: 0.8rem; }
  .inline-detail .connections h4 { color: var(--accent3); margin-bottom: 0.4rem; font-size: 0.92rem; }
  .inline-detail .conn-item {
    display: flex; align-items: center; gap: 0.4rem;
    padding: 0.4rem 0.6rem; border-radius: 6px; margin-bottom: 0.25rem;
    background: var(--conn-bg); font-size: 0.88rem;
  }

  /* === HOW-TO === */
  .howto-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.2rem; }
  .howto-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 14px; padding: 1.4rem; transition: all 0.3s;
  }
  .howto-card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 4px 16px rgba(255,215,0,0.06); }
  .howto-card .card-icon { font-size: 2rem; margin-bottom: 0.6rem; }
  .howto-card h3 { margin-bottom: 0.4rem; font-size: 1rem; }
  .howto-card p { color: var(--text-dim); line-height: 1.7; font-size: 0.88rem; }
  .howto-card .steps {
    margin-top: 0.8rem; padding-left: 1.2rem;
    list-style: none; counter-reset: step;
  }
  .howto-card .steps li {
    counter-increment: step; position: relative;
    padding: 0.25rem 0; color: var(--text-dim); font-size: 0.88rem;
  }
  .howto-card .steps li::before {
    content: counter(step); position: absolute; left: -1.4rem;
    color: var(--accent); font-weight: 700; font-size: 0.78rem;
  }

  /* === SEARCH === */
  .search-bar {
    display: flex; align-items: center; gap: 0.5rem;
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 0.5rem 0.8rem; margin-bottom: 1.2rem;
  }
  .search-bar input {
    flex: 1; background: none; border: none; color: var(--text);
    font-size: 0.9rem; outline: none;
  }
  .search-bar input::placeholder { color: var(--text-dim); }

  /* === STARRY BG === */
  .starry-bg {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 0; pointer-events: none; overflow: hidden;
  }
  .starry-bg .star {
    position: absolute; width: 2px; height: 2px;
    background: #ffd43b; border-radius: 50%;
    animation: twinkle var(--dur, 3s) ease-in-out infinite alternate;
  }
  .starry-bg .star.dim { background: rgba(255,255,255,0.5); width: 1px; height: 1px; }
  @keyframes twinkle { from { opacity: 0.2; transform: scale(0.8); } to { opacity: 1; transform: scale(1.2); } }
  .starry-bg .nebula { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.15; }
  [data-theme="light"] .starry-bg { display: none; }
  [data-theme="light"] body { background-image: none; }

  /* === TOOLTIP === */
  .tooltip {
    position: fixed; background: var(--nav-bg); border: 1px solid var(--accent);
    border-radius: 8px; padding: 0.5rem 0.8rem; font-size: 0.82rem;
    pointer-events: none; z-index: 200; opacity: 0; transition: opacity 0.2s;
    max-width: 240px; box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    backdrop-filter: blur(12px);
  }
  .tooltip.visible { opacity: 1; }

  /* === FOOTER === */
  footer {
    padding: 2rem; text-align: center; margin-top: 3rem;
    border-top: 1px solid var(--border); color: var(--text-dim); font-size: 0.88rem;
    position: relative; z-index: 1;
  }
  footer .brand { color: var(--accent); font-weight: 700; font-size: 1.05rem; margin-bottom: 0.3rem; }
  footer a { color: var(--accent); text-decoration: none; font-weight: 600; border-bottom: 1px dashed var(--accent); }
  footer a:hover { opacity: 0.8; }

  /* === TRANSITIONS === */
  body, nav, .story-step, .arch-diagram, .howto-card, .inline-detail,
  .search-bar, .arch-legend, .tooltip, footer {
    transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
  }
  [data-theme="light"] .arch-diagram { box-shadow: 0 2px 10px rgba(0,0,0,0.06); }

  /* === QUALITY TAB === */
  .quality-section { margin-bottom: 2rem; }
  .quality-section h3 {
    color: var(--accent); font-size: 1.1rem; margin-bottom: 1rem;
    padding-bottom: 0.4rem; border-bottom: 1px solid var(--border);
  }
  .stat-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem; margin-bottom: 1.5rem;
  }
  .stat-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 1.2rem; text-align: center;
    transition: all 0.3s;
  }
  .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(255,215,0,0.06); }
  .stat-card .stat-value { font-size: 2rem; font-weight: 700; color: var(--accent); }
  .stat-card .stat-label { color: var(--text-dim); font-size: 0.88rem; margin-top: 0.3rem; }
  .security-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1rem; margin-bottom: 1.5rem;
  }
  .security-card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 1.2rem; transition: all 0.3s;
  }
  .security-card:hover { border-color: var(--accent4); transform: translateY(-2px); }
  .security-card .sec-icon { font-size: 1.5rem; margin-bottom: 0.4rem; }
  .security-card h4 { font-size: 0.95rem; margin-bottom: 0.3rem; }
  .security-card p { color: var(--text-dim); font-size: 0.85rem; line-height: 1.6; }
  .badge-row {
    display: flex; flex-wrap: wrap; gap: 0.6rem;
  }
  .quality-badge {
    display: inline-flex; align-items: center; gap: 0.3rem;
    background: var(--glow); color: var(--accent); border: 1px solid rgba(255,215,0,0.2);
    padding: 0.35rem 0.8rem; border-radius: 20px; font-size: 0.82rem; font-weight: 600;
  }

  /* === STAR ECONOMY TAB === */
  #economy-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
  }
  #quest-matrix {
    display: grid;
    grid-template-columns: 80px repeat(3, 1fr);
    grid-template-rows: 44px repeat(3, 1fr);
    gap: 4px;
  }
  .matrix-header {
    display: flex; align-items: center; justify-content: center;
    font-size: 0.85rem; font-weight: 700; text-align: center;
    padding: 6px; border-radius: 12px;
  }
  .matrix-header-bonus    { background: rgba(255,215,0,0.15); color: var(--accent); }
  .matrix-header-duty     { background: rgba(239,68,68,0.12); color: var(--danger); }
  .matrix-header-violation { background: rgba(245,158,11,0.12); color: #F59E0B; }
  .matrix-row-label {
    display: flex; align-items: center;
    font-size: 0.85rem; color: var(--text-dim); padding-right: 4px;
  }
  .matrix-cell {
    border-radius: 12px; padding: 10px 8px; text-align: center;
    cursor: pointer; transition: all 0.2s;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 2px; border: 1px solid transparent; font-size: 0.85rem;
  }
  .matrix-cell:hover { transform: scale(1.06); border-color: var(--accent); }
  .matrix-cell-bonus     { background: rgba(255,215,0,0.1); color: var(--accent); }
  .matrix-cell-duty      { background: rgba(239,68,68,0.1); color: var(--danger); }
  .matrix-cell-violation  { background: rgba(245,158,11,0.1); color: #F59E0B; }
  .matrix-stars { font-weight: 800; font-size: 1rem; }
  .matrix-range { font-size: 0.78rem; opacity: 0.7; }
  #matrix-tooltip {
    position: absolute; background: var(--nav-bg); border: 1px solid var(--border);
    border-radius: 12px; padding: 12px 16px; font-size: 0.85rem;
    max-width: 220px; z-index: 100; pointer-events: none;
    opacity: 0; transition: opacity 0.2s; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    backdrop-filter: blur(12px);
  }
  #matrix-tooltip.visible { opacity: 1; }
  #star-flow {
    display: flex; flex-direction: column; gap: 16px; align-items: center;
  }
  .econ-flow-node {
    padding: 14px 24px; border-radius: 14px; font-weight: 700;
    text-align: center; width: 180px;
  }
  .econ-flow-node-earn {
    background: rgba(255,215,0,0.15); border: 2px solid rgba(255,215,0,0.4); color: var(--accent);
  }
  .econ-flow-node-balance {
    background: rgba(79,70,229,0.25); border: 2px solid rgba(79,70,229,0.5); color: #a5b4fc;
  }
  .econ-flow-node-reward {
    background: rgba(16,185,129,0.15); border: 2px solid rgba(16,185,129,0.4); color: var(--accent4);
  }
  .econ-flow-arrow { font-size: 1.5rem; color: var(--text-dim); line-height: 1; }
  #credit-mini {
    margin-top: 20px; padding: 16px 20px;
    background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.25);
    border-radius: 14px; font-size: 0.85rem; text-align: center;
  }
  #credit-mini h4 { color: #F59E0B; margin-bottom: 6px; font-size: 0.9rem; }
  #credit-mini p { color: var(--text-dim); line-height: 1.5; }

  /* === DATABASE TAB === */
  #schema-tables {
    display: flex; gap: 12px; align-items: flex-start;
    flex-wrap: wrap; justify-content: center;
  }
  .db-table {
    background: rgba(13,17,23,0.8); border: 1px solid rgba(16,185,129,0.25);
    border-radius: 12px; min-width: 140px; overflow: hidden;
    font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.82rem;
    transition: all 0.2s;
  }
  .db-table:hover { border-color: rgba(255,215,0,0.4); box-shadow: 0 0 16px rgba(255,215,0,0.1); }
  .db-table.view-table { border: 2px solid rgba(255,215,0,0.5); box-shadow: 0 0 20px rgba(255,215,0,0.1); }
  .db-table-header {
    padding: 8px 12px; background: rgba(16,185,129,0.12);
    border-bottom: 1px solid rgba(16,185,129,0.2);
    font-weight: 700; color: var(--accent4); font-size: 0.85rem;
  }
  .db-table.view-table .db-table-header { background: rgba(255,215,0,0.1); color: var(--accent); }
  .db-table-row {
    padding: 5px 12px; border-bottom: 1px solid rgba(255,255,255,0.04);
    color: var(--text-dim); display: flex; align-items: center; gap: 6px;
    transition: all 0.3s;
  }
  .db-table-row:last-child { border-bottom: none; }
  .db-table-row.pk { color: var(--accent2); }
  .db-table-row.fk { color: #a5b4fc; }
  .col-icon { font-size: 0.78rem; opacity: 0.7; }
  .db-rls-banner {
    padding: 12px 20px; background: rgba(79,70,229,0.15);
    border: 1px solid rgba(79,70,229,0.3); border-radius: 12px;
    font-size: 0.85rem; color: #a5b4fc; text-align: center; margin-top: 1rem;
  }
  #db-demo { display: flex; flex-direction: column; gap: 16px; margin-top: 1.5rem; }
  #db-demo-btns { display: flex; gap: 12px; flex-wrap: wrap; }
  .db-demo-btn {
    padding: 10px 22px; border-radius: 12px; font-size: 0.9rem;
    font-weight: 600; cursor: pointer; border: none; transition: all 0.2s;
  }
  .db-demo-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .db-demo-btn-insert {
    background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(5,150,105,0.2));
    border: 1px solid rgba(16,185,129,0.5); color: var(--accent4);
  }
  .db-demo-btn-approve {
    background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(251,191,36,0.1));
    border: 1px solid rgba(255,215,0,0.4); color: var(--accent);
  }
  .db-demo-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
  .db-demo-btn:active:not(:disabled) { transform: translateY(0); }
  #db-live-table {
    background: rgba(13,17,23,0.8); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px; overflow: hidden;
    font-family: 'SF Mono', 'Fira Code', monospace; font-size: 0.85rem;
  }
  #db-live-table-header {
    display: grid; grid-template-columns: 80px 160px 80px 80px 100px;
    padding: 8px 12px; background: rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.08);
    color: var(--text-dim); font-weight: 700; font-size: 0.82rem;
  }
  .db-live-row {
    display: grid; grid-template-columns: 80px 160px 80px 80px 100px;
    padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,0.04);
    color: var(--text-dim); transition: all 0.3s;
  }
  .db-live-row:last-child { border-bottom: none; }
  .db-live-row .id-col { color: #a5b4fc; }
  .db-live-row .desc-col { color: var(--text); }
  .db-live-row .stars-col { color: var(--accent); }
  .badge-pending {
    background: rgba(251,191,36,0.15); color: #FBBF24;
    padding: 2px 8px; border-radius: 8px; font-size: 0.78rem; font-weight: 600;
  }
  .badge-approved {
    background: rgba(16,185,129,0.15); color: var(--accent4);
    padding: 2px 8px; border-radius: 8px; font-size: 0.78rem; font-weight: 600;
  }
  #db-balance-display {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 20px; background: rgba(255,215,0,0.08);
    border: 1px solid rgba(255,215,0,0.2); border-radius: 12px;
  }
  #db-balance-label { color: var(--text-dim); font-size: 0.85rem; }
  #db-balance-value { font-size: 1.6rem; font-weight: 900; color: var(--accent); font-family: monospace; }
  @keyframes rowInsert { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes goldFlash { 0% { background: transparent; } 50% { background: rgba(255,215,0,0.3); } 100% { background: transparent; } }

  /* === RESPONSIVE === */
  @media (max-width: 768px) {
    nav { padding: 0 0.8rem; }
    nav .tabs button { padding: 0.35rem 0.5rem; font-size: 0.78rem; }
    nav .logo { font-size: 1rem; }
    main { padding: 1rem; }
    .hero h1 { font-size: 1.7rem; }
    .howto-grid { grid-template-columns: 1fr; }
    .security-grid { grid-template-columns: 1fr; }
    .stat-grid { grid-template-columns: repeat(2, 1fr); }
    #economy-grid { grid-template-columns: 1fr; }
    #db-live-table-header, .db-live-row { grid-template-columns: 60px 120px 60px 70px 80px; font-size: 0.78rem; }
    #schema-tables { overflow-x: auto; }
  }
  @media (max-width: 480px) {
    nav .logo { display: none; }
    nav .tabs button { padding: 0.3rem 0.4rem; font-size: 0.72rem; }
    .hero h1 { font-size: 1.3rem; }
    .hero .subtitle { font-size: 0.95rem; }
    .stat-grid { grid-template-columns: 1fr 1fr; }
    .badge-row { gap: 0.4rem; }
    .quality-badge { font-size: 0.72rem; padding: 0.25rem 0.6rem; }
  }
</style>
</head>
<body>

<div class="starry-bg" id="starry-bg"></div>

<nav>
  <div class="logo">‚≠ê StarQuest</div>
  <div class="tabs">
    <button class="active" data-tab="story" onclick="switchTab('story')">
      <span data-en="Story" data-zh="ÊïÖ‰∫ã">Story</span>
    </button>
    <button data-tab="architecture" onclick="switchTab('architecture')">
      <span data-en="Architecture" data-zh="Êû∂ÊûÑ">Architecture</span>
    </button>
    <button data-tab="howto" onclick="switchTab('howto')">
      <span data-en="How to Use" data-zh="‰ΩøÁî®ÊåáÂçó">How to Use</span>
    </button>
    <button data-tab="dataflow" onclick="switchTab('dataflow')">
      <span data-en="Data Flow" data-zh="Êï∞ÊçÆÊµÅ">Data Flow</span>
    </button>
    <button data-tab="quality" onclick="switchTab('quality')">
      <span data-en="Quality" data-zh="Ë¥®Èáè">Quality</span>
    </button>
    <button data-tab="economy" onclick="switchTab('economy')">
      <span data-en="Featured Functions" data-zh="ÁâπËâ≤ÂäüËÉΩ">Featured Functions</span>
    </button>
    <button data-tab="database" onclick="switchTab('database')">
      <span data-en="Database" data-zh="Êï∞ÊçÆÂ∫ì">Database</span>
    </button>
  </div>
  <div class="nav-controls">
    <button class="ctrl-btn" onclick="toggleTheme()" id="theme-btn" title="Toggle theme">üåô</button>
    <button class="ctrl-btn" onclick="toggleLang()">EN / ‰∏≠Êñá</button>
  </div>
</nav>

<main>
<!-- ========== TAB 1: STORY MODE ========== -->
<section id="tab-story" class="active">
  <div class="hero">
    <div class="mascot">üêã</div>
    <h1><span data-en="The Quest for Stars" data-zh="ÊòüËæ∞Êé¢Á¥¢‰πãÊóÖ">The Quest for Stars</span></h1>
    <p class="subtitle"><span data-en="StarQuest turns everyday tasks into epic family adventures! Parents create quests, children earn shining stars, and everyone grows together. Built with Next.js 15 + Supabase ‚Äî bilingual, secure, and fun." data-zh="StarQuest ÊääÊó•Â∏∏‰ªªÂä°ÂèòÊàêÂÆ∂Â∫≠ÂÜíÈô©ÔºÅÁà∂ÊØçÂàõÂª∫‰ªªÂä°ÔºåÂ≠©Â≠êËµöÂèñÈó™‰∫ÆÁöÑÊòüÊòüÔºå‰∏ÄÂÆ∂‰∫∫ÂÖ±ÂêåÊàêÈïø„ÄÇÂü∫‰∫é Next.js 15 + Supabase ÊûÑÂª∫ ‚Äî ÂèåËØ≠„ÄÅÂÆâÂÖ®„ÄÅÊúâË∂£„ÄÇ">StarQuest turns everyday tasks into epic family adventures! Parents create quests, children earn shining stars, and everyone grows together. Built with Next.js 15 + Supabase ‚Äî bilingual, secure, and fun.</span></p>
  </div>

  <div class="story-timeline" id="story-timeline">
    <div class="story-step" data-icon="üêã">
      <span class="step-num">ACT 1 ‚Äî WHAT</span>
      <h3><span data-en="Once upon a time, in a family far away..." data-zh="Âæà‰πÖÂæà‰πÖ‰ª•ÂâçÔºåÂú®‰∏Ä‰∏™ÈÅ•ËøúÁöÑÂÆ∂Â∫≠Èáå‚Ä¶‚Ä¶">Once upon a time, in a family far away...</span></h3>
      <p><span data-en="Parents wished they could turn chores and good habits into a game. StarQuest was born ‚Äî a magical star chart where kids complete quests, earn stars, and trade them for awesome rewards!" data-zh="Áà∂ÊØç‰ª¨Â∏åÊúõËÉΩÊääÂÆ∂Âä°ÂíåÂ•Ω‰π†ÊÉØÂèòÊàêÊ∏∏Êàè„ÄÇStarQuest ËØûÁîü‰∫Ü ‚Äî ‰∏Ä‰∏™Á•ûÂ•áÁöÑÊòüÂõæÁ≥ªÁªüÔºåÂ≠©Â≠ê‰ª¨ÂÆåÊàê‰ªªÂä°„ÄÅËµöÂèñÊòüÊòüÔºåÁî®ÊòüÊòüÊç¢ÂèñË∂ÖÊ£íÁöÑÂ•ñÂä±ÔºÅ">Parents wished they could turn chores and good habits into a game. StarQuest was born ‚Äî a magical star chart where kids complete quests, earn stars, and trade them for awesome rewards!</span></p>
      <div class="detail"><span data-en="StarQuest classifies every quest along two dimensions: Type (bonus, duty, violation) and Scope (self, family, others). This creates a rich 3x3 matrix of behaviors. Children only see bonus quests ‚Äî keeping their experience positive. Parents see all types to track the full picture. The app speaks both English and Chinese." data-zh="StarQuest Áî®‰∏§‰∏™Áª¥Â∫¶ÂàÜÁ±ªÊØè‰∏™‰ªªÂä°ÔºöÁ±ªÂûãÔºàÂ•ñÂä±„ÄÅ‰πâÂä°„ÄÅËøùËßÑÔºâÂíåËåÉÂõ¥ÔºàËá™Êàë„ÄÅÂÆ∂Â∫≠„ÄÅ‰ªñ‰∫∫Ôºâ„ÄÇËøôÂΩ¢Êàê‰∫Ü 3x3 Ë°å‰∏∫Áü©Èòµ„ÄÇÂ≠©Â≠êÂè™ÁúãÂà∞Â•ñÂä±‰ªªÂä° ‚Äî ‰øùÊåÅÁßØÊûÅ‰ΩìÈ™å„ÄÇÁà∂ÊØçÁúãÂà∞ÊâÄÊúâÁ±ªÂûãÊéåÊè°ÂÖ®Â±Ä„ÄÇÂ∫îÁî®ÊîØÊåÅ‰∏≠Ëã±ÂèåËØ≠„ÄÇ">StarQuest classifies every quest along two dimensions: Type (bonus, duty, violation) and Scope (self, family, others). This creates a rich 3x3 matrix of behaviors. Children only see bonus quests ‚Äî keeping their experience positive. Parents see all types to track the full picture. The app speaks both English and Chinese.</span></div>
    </div>

    <div class="story-step" data-icon="üé≠">
      <span class="step-num">ACT 2 ‚Äî WHO</span>
      <h3><span data-en="Meet the heroes behind the curtain" data-zh="ËÆ§ËØÜÂπïÂêéÁöÑËã±ÈõÑ‰ª¨">Meet the heroes behind the curtain</span></h3>
      <p><span data-en="Six characters work together: the Frontend (storefront window), the Server (the brain), the Database (a vault that never forgets), Auth (the security guard), Email (the messenger owl), and Analytics (the wise oracle)." data-zh="ÂÖ≠‰∏™ËßíËâ≤ÂçèÂäõÂêà‰ΩúÔºöÂâçÁ´ØÔºàÊºÇ‰∫ÆÊ©±Á™óÔºâ„ÄÅÊúçÂä°Á´ØÔºàÂ§ßËÑëÔºâ„ÄÅÊï∞ÊçÆÂ∫ìÔºàÊ∞∏‰∏çÈÅóÂøòÁöÑ‰øùÈô©Â∫ìÔºâ„ÄÅËÆ§ËØÅÔºàÂÆâ‰øù‰∫∫ÂëòÔºâ„ÄÅÈÇÆ‰ª∂Ôºà‰ø°‰ΩøÁå´Â§¥Èπ∞Ôºâ„ÄÅÊï∞ÊçÆÂàÜÊûêÔºàÊô∫ÊÖßÂÖàÁü•Ôºâ„ÄÇ">Six characters work together: the Frontend (storefront window), the Server (the brain), the Database (a vault that never forgets), Auth (the security guard), Email (the messenger owl), and Analytics (the wise oracle).</span></p>
      <div class="detail"><span data-en="üåê Frontend (React + Tailwind) ‚Äî Colorful LEGO bricks for every screen. Uses next-intl for bilingual magic.
üß† Server (Next.js 15) ‚Äî Pre-cooks pages for speed. Runs API routes and cron jobs.
üóÑÔ∏è Database (Supabase + PostgreSQL) ‚Äî Stores families, quests, stars, rewards. Row-Level Security: each family only sees their own data.
üîí Auth (Middleware) ‚Äî Checks every visitor's badge before letting them in.
üìß Email (Resend) ‚Äî Sends weekly reports, monthly summaries, and invitation emails.
üìä Analytics (PostHog) ‚Äî Privacy-first tracking. Children are anonymous!" data-zh="üåê ÂâçÁ´Ø (React + Tailwind) ‚Äî ÊãºÊê≠ÁïåÈù¢ÁöÑÂΩ©Ëâ≤ÁßØÊú®„ÄÇÁî® next-intl ÂÆûÁé∞ÂèåËØ≠ÂàáÊç¢„ÄÇ
üß† ÊúçÂä°Á´Ø (Next.js 15) ‚Äî È¢ÑÊ∏≤ÊüìÈ°µÈù¢ÈÄüÂ∫¶È£ûÂø´„ÄÇËøêË°å API Ë∑ØÁî±ÂíåÂÆöÊó∂‰ªªÂä°„ÄÇ
üóÑÔ∏è Êï∞ÊçÆÂ∫ì (Supabase + PostgreSQL) ‚Äî Â≠òÂÇ®ÂÆ∂Â∫≠„ÄÅ‰ªªÂä°„ÄÅÊòüÊòü„ÄÅÂ•ñÂä±„ÄÇË°åÁ∫ßÂÆâÂÖ®ÔºöÊØèÂÆ∂Âè™ÁúãËá™Â∑±ÁöÑÊï∞ÊçÆ„ÄÇ
üîí ËÆ§ËØÅ (‰∏≠Èó¥‰ª∂) ‚Äî ËøõÂÖ•ÂâçÊ£ÄÊü•ÊØè‰∏™ËÆøÂÆ¢ÁöÑË∫´‰ªΩ„ÄÇ
üìß ÈÇÆ‰ª∂ (Resend) ‚Äî Ëá™Âä®ÂèëÈÄÅÂë®Êä•„ÄÅÊúàÊä•ÂíåÈÇÄËØ∑ÈÇÆ‰ª∂„ÄÇ
üìä Êï∞ÊçÆÂàÜÊûê (PostHog) ‚Äî ÈöêÁßÅ‰ºòÂÖàËøΩË∏™„ÄÇÂÑøÁ´•ÂÆåÂÖ®ÂåøÂêçÔºÅ">üåê Frontend (React + Tailwind) ‚Äî Colorful LEGO bricks for every screen. Uses next-intl for bilingual magic.
üß† Server (Next.js 15) ‚Äî Pre-cooks pages for speed. Runs API routes and cron jobs.
üóÑÔ∏è Database (Supabase + PostgreSQL) ‚Äî Stores families, quests, stars, rewards. Row-Level Security: each family only sees their own data.
üîí Auth (Middleware) ‚Äî Checks every visitor's badge before letting them in.
üìß Email (Resend) ‚Äî Sends weekly reports, monthly summaries, and invitation emails.
üìä Analytics (PostHog) ‚Äî Privacy-first tracking. Children are anonymous!</span></div>
    </div>

    <div class="story-step" data-icon="üìã">
      <span class="step-num">ACT 3 ‚Äî CREATE</span>
      <h3><span data-en="The adventure begins: Parent creates a quest" data-zh="ÂÜíÈô©ÂºÄÂßãÔºöÂÆ∂ÈïøÂàõÂª∫‰ªªÂä°">The adventure begins: Parent creates a quest</span></h3>
      <p><span data-en="Mom opens StarQuest and creates 'Help with Dishes' as a Bonus quest worth 15 stars. She picks Family scope and Chores category. The quest is saved ‚Äî ready for Alisa to discover!" data-zh="Â¶àÂ¶àÊâìÂºÄ StarQuestÔºåÂàõÂª∫‰∫Ü"Â∏ÆÂøôÊ¥óÁ¢ó"Â•ñÂä±‰ªªÂä°Ôºå‰ª∑ÂÄº 15 Êòü„ÄÇÈÄâÊã©"ÂÆ∂Â∫≠"ËåÉÂõ¥Âíå"ÂÆ∂Âä°"Á±ªÂà´„ÄÇ‰ªªÂä°Â∑≤‰øùÂ≠ò ‚Äî Á≠â Alisa Êù•ÂèëÁé∞ÔºÅ">Mom opens StarQuest and creates 'Help with Dishes' as a Bonus quest worth 15 stars. She picks Family scope and Chores category. The quest is saved ‚Äî ready for Alisa to discover!</span></p>
      <div class="detail"><span data-en="Quest classification: Bonus (earn stars), Duty (lose stars if missed), Violation (lose stars when broken). Scope: Self, Family, Others. Parents can set a star multiplier (1x-10x) for exceptional effort!" data-zh="‰ªªÂä°ÂàÜÁ±ªÔºöÂ•ñÂä±ÔºàÂÆåÊàêÂæóÊòüÔºâ„ÄÅ‰πâÂä°ÔºàÊú™ÂÆåÊàêÊâ£ÊòüÔºâ„ÄÅËøùËßÑÔºàÁäØËßÑÊâ£ÊòüÔºâ„ÄÇËåÉÂõ¥ÔºöËá™Êàë„ÄÅÂÆ∂Â∫≠„ÄÅ‰ªñ‰∫∫„ÄÇÂÆ∂ÈïøÂèØËÆæÊòüÊòüÂÄçÁéáÔºà1x-10xÔºâÂ•ñÂä±ÁâπÂà´Âä™ÂäõÔºÅ">Quest classification: Bonus (earn stars), Duty (lose stars if missed), Violation (lose stars when broken). Scope: Self, Family, Others. Parents can set a star multiplier (1x-10x) for exceptional effort!</span></div>
    </div>

    <div class="story-step" data-icon="üëß">
      <span class="step-num">ACT 4 ‚Äî DISCOVER</span>
      <h3><span data-en="Alisa discovers the quest" data-zh="Alisa ÂèëÁé∞‰∫Ü‰ªªÂä°">Alisa discovers the quest</span></h3>
      <p><span data-en="Alisa opens her phone and sees 'Help with Dishes' bouncing in. She only sees bonus quests ‚Äî duty and violation quests are hidden, keeping her experience positive and fun!" data-zh="Alisa ÊâìÂºÄÊâãÊú∫ÔºåÁúãÂà∞"Â∏ÆÂøôÊ¥óÁ¢ó"ÂºπÂá∫Êù•„ÄÇÂ•πÂè™ËÉΩÁúãÂà∞Â•ñÂä±‰ªªÂä° ‚Äî ‰πâÂä°ÂíåËøùËßÑ‰ªªÂä°ÊòØÈöêËóèÁöÑÔºå‰øùÊåÅ‰ΩìÈ™åÁßØÊûÅÊúâË∂£ÔºÅ">Alisa opens her phone and sees 'Help with Dishes' bouncing in. She only sees bonus quests ‚Äî duty and violation quests are hidden, keeping her experience positive and fun!</span></p>
      <div class="detail"><span data-en="The child view uses getChildVisibleQuests() to filter. This is a core design principle: children see encouraging bonus adventures, parents see the full picture. Filtering runs server-side ‚Äî filtered data never reaches the child's browser." data-zh="ÂÑøÁ´•ËßÜÂõæÁî® getChildVisibleQuests() ËøáÊª§„ÄÇÊ†∏ÂøÉËÆæËÆ°ÁêÜÂøµÔºöÂ≠©Â≠êÁúãÂà∞Ê≠£Èù¢ÁöÑÂ•ñÂä±ÂÜíÈô©ÔºåÂÆ∂ÈïøÁúãÂà∞ÂÆåÊï¥ÁîªÈù¢„ÄÇËøáÊª§Âú®ÊúçÂä°Á´ØÂÆåÊàê ‚Äî Ë¢´ËøáÊª§ÁöÑÊï∞ÊçÆ‰∏ç‰ºöÂà∞ËææÂ≠©Â≠êÁöÑÊµèËßàÂô®„ÄÇ">The child view uses getChildVisibleQuests() to filter. This is a core design principle: children see encouraging bonus adventures, parents see the full picture. Filtering runs server-side ‚Äî filtered data never reaches the child's browser.</span></div>
    </div>

    <div class="story-step" data-icon="‚≠ê">
      <span class="step-num">ACT 5 ‚Äî EARN</span>
      <h3><span data-en="Stars requested, stars approved!" data-zh="Áî≥ËØ∑ÊòüÊòüÔºåËé∑ÊâπÈÄöËøáÔºÅ">Stars requested, stars approved!</span></h3>
      <p><span data-en="Alisa washes all the dishes and taps 'Request Stars' with a note. The request goes pending. Mom reviews, clicks Approve, and Alisa's balance jumps from 265 to 280 stars!" data-zh="Alisa Ê¥óÂÆåÊâÄÊúâÁ¢óÔºåÁÇπÂáª"Áî≥ËØ∑ÊòüÊòü"Âπ∂ÈôÑË®Ä„ÄÇËØ∑Ê±ÇËøõÂÖ•ÂæÖÂÆ°Êâπ„ÄÇÂ¶àÂ¶àÂÆ°Ê†∏ÂêéÁÇπÂáªÊâπÂáÜÔºåAlisa ‰ΩôÈ¢ù‰ªé 265 Ë∑≥Âà∞ 280 ÊòüÔºÅ">Alisa washes all the dishes and taps 'Request Stars' with a note. The request goes pending. Mom reviews, clicks Approve, and Alisa's balance jumps from 265 to 280 stars!</span></p>
      <div class="detail"><span data-en="Flow: INSERT star_transactions (pending) -> parent reviews -> UPDATE (approved) -> child_balances VIEW auto-recalculates. Parents can batch-approve or set custom dates for backdating." data-zh="ÊµÅÁ®ãÔºöINSERT star_transactions (ÂæÖÂÆ°Êâπ) -> ÂÆ∂ÈïøÂÆ°Ê†∏ -> UPDATE (Â∑≤ÊâπÂáÜ) -> child_balances ËßÜÂõæËá™Âä®ÈáçÁÆó„ÄÇÂÆ∂ÈïøÂèØÊâπÈáèÂÆ°ÊâπÊàñËÆæËá™ÂÆö‰πâÊó•ÊúüË°•ÂΩï„ÄÇ">Flow: INSERT star_transactions (pending) -> parent reviews -> UPDATE (approved) -> child_balances VIEW auto-recalculates. Parents can batch-approve or set custom dates for backdating.</span></div>
    </div>

    <div class="story-step" data-icon="ü§ù">
      <span class="step-num">ACT 6 ‚Äî COLLABORATE</span>
      <h3><span data-en="How the characters work together" data-zh="ËßíËâ≤‰ª¨Â¶Ç‰ΩïÂçè‰Ωú">How the characters work together</span></h3>
      <p><span data-en="Frontend: 'Alisa wants stars!' -> Server: 'Let me check with Auth.' -> Auth: 'She's legit!' -> Database: 'Saved! Pending.' -> Email: 'Hey Mom, new request!' -> Analytics: 'Tracked it.'" data-zh="ÂâçÁ´ØÔºö"Alisa Ë¶ÅÊòüÊòüÔºÅ"-> ÊúçÂä°Á´ØÔºö"ËÆ©ÊàëÈóÆÈóÆËÆ§ËØÅ„ÄÇ"-> ËÆ§ËØÅÔºö"Ê≤°ÈóÆÈ¢òÔºÅ"-> Êï∞ÊçÆÂ∫ìÔºö"Â∑≤‰øùÂ≠òÔºÅÂæÖÂÆ°Êâπ„ÄÇ"-> ÈÇÆ‰ª∂Ôºö"Â¶àÂ¶àÔºåÊñ∞ËØ∑Ê±ÇÔºÅ"-> ÂàÜÊûêÔºö"Â∑≤ËÆ∞ÂΩï„ÄÇ"">Frontend: 'Alisa wants stars!' -> Server: 'Let me check with Auth.' -> Auth: 'She's legit!' -> Database: 'Saved! Pending.' -> Email: 'Hey Mom, new request!' -> Analytics: 'Tracked it.'</span></p>
      <div class="detail"><span data-en="Maps to real code: React fetch('/api/...') -> Next.js API route -> middleware.ts checks session -> Supabase INSERT -> PostHog captures event -> Cron job emails weekly summary. All tables use family_id + RLS ‚Äî PostgreSQL itself refuses cross-family queries." data-zh="Êò†Â∞ÑÁúüÂÆû‰ª£Á†ÅÔºöReact fetch('/api/...') -> Next.js API Ë∑ØÁî± -> middleware.ts Ê£ÄÊü•‰ºöËØù -> Supabase INSERT -> PostHog ÊçïËé∑‰∫ã‰ª∂ -> ÂÆöÊó∂‰ªªÂä°ÂèëÈÄÅÂë®Êä•„ÄÇÊâÄÊúâË°®Áî® family_id + RLS ‚Äî PostgreSQL Êú¨Ë∫´ÊãíÁªùË∑®ÂÆ∂Â∫≠Êü•ËØ¢„ÄÇ">Maps to real code: React fetch('/api/...') -> Next.js API route -> middleware.ts checks session -> Supabase INSERT -> PostHog captures event -> Cron job emails weekly summary. All tables use family_id + RLS ‚Äî PostgreSQL itself refuses cross-family queries.</span></div>
    </div>

    <div class="story-step" data-icon="üöÄ">
      <span class="step-num">ACT 7 ‚Äî SUPERPOWERS</span>
      <h3><span data-en="Secret superpowers of StarQuest" data-zh="StarQuest ÁöÑÁßòÂØÜË∂ÖËÉΩÂäõ">Secret superpowers of StarQuest</span></h3>
      <p><span data-en="üí≥ Credit System ‚Äî borrow stars with real interest! üìß Auto-Reports ‚Äî weekly/monthly emails. üé≠ Demo Mode ‚Äî one-click, 30 days of data. üß™ 2,849 tests, ~99% coverage!" data-zh="üí≥ ‰ø°Áî®Á≥ªÁªü ‚Äî ÂÄüÊòüÊòüÊúâÂà©ÊÅØÔºÅüìß Ëá™Âä®Êä•Âëä ‚Äî Âë®Êä•/ÊúàÊä•ÈÇÆ‰ª∂„ÄÇüé≠ ÊºîÁ§∫Ê®°Âºè ‚Äî ‰∏ÄÈîÆ‰ΩìÈ™å 30 Â§©Êï∞ÊçÆ„ÄÇüß™ 2,849 ÊµãËØïÔºåÁ∫¶ 99% Ë¶ÜÁõñÁéáÔºÅ">üí≥ Credit System ‚Äî borrow stars with real interest! üìß Auto-Reports ‚Äî weekly/monthly emails. üé≠ Demo Mode ‚Äî one-click, 30 days of data. üß™ 2,849 tests, ~99% coverage!</span></p>
      <div class="detail"><span data-en="Credit: credit_settings, credit_transactions, interest_tiers. Kids borrow now, repay with interest ‚Äî teaching financial literacy!
Reports: Cron at /api/cron/daily-jobs generates Markdown via fetchReportBaseData() + buildChildrenStats(), sends via Resend.
Demo: POST /api/seed-demo creates family with 45 quests, 11 rewards, 2 children, 30 days of activity. Passwordless magic link login.
Testing: Jest + React Testing Library. Every component, hook, API route tested." data-zh="‰ø°Áî®Ôºöcredit_settings, credit_transactions, interest_tiers„ÄÇÂ≠©Â≠êÁé∞Âú®ÂÄüÔºå‰ª•ÂêéËøòÂà©ÊÅØ ‚Äî ÊïôÁêÜË¥¢Á¥†ÂÖªÔºÅ
Êä•ÂëäÔºö/api/cron/daily-jobs ÂÆöÊó∂‰ªªÂä°ÈÄöËøá fetchReportBaseData() + buildChildrenStats() ÁîüÊàê MarkdownÔºåÈÄöËøá Resend ÂèëÈÄÅ„ÄÇ
ÊºîÁ§∫ÔºöPOST /api/seed-demo ÂàõÂª∫ÂÆ∂Â∫≠Ôºå45 ‰∏™‰ªªÂä°„ÄÅ11 Â•ñÂä±„ÄÅ2 Â≠©Â≠ê„ÄÅ30 Â§©Ê¥ªÂä®„ÄÇÊó†ÂØÜÁ†ÅÈ≠îÊ≥ïÈìæÊé•ÁôªÂΩï„ÄÇ
ÊµãËØïÔºöJest + React Testing Library„ÄÇÊØè‰∏™ÁªÑ‰ª∂„ÄÅhook„ÄÅAPI Ë∑ØÁî±ÈÉΩÊúâÊµãËØï„ÄÇ">Credit: credit_settings, credit_transactions, interest_tiers. Kids borrow now, repay with interest ‚Äî teaching financial literacy!
Reports: Cron at /api/cron/daily-jobs generates Markdown via fetchReportBaseData() + buildChildrenStats(), sends via Resend.
Demo: POST /api/seed-demo creates family with 45 quests, 11 rewards, 2 children, 30 days of activity. Passwordless magic link login.
Testing: Jest + React Testing Library. Every component, hook, API route tested.</span></div>
    </div>
  </div>
</section>

<!-- ========== TAB 2: ARCHITECTURE ========== -->
<section id="tab-architecture">
  <h2 style="margin-bottom:1.2rem;color:var(--accent);font-size:1.5rem">
    <span data-en="System Architecture" data-zh="Á≥ªÁªüÊû∂ÊûÑ">System Architecture</span>
  </h2>
  <div class="search-bar">
    <span>üîç</span>
    <input type="text" id="arch-search" placeholder="Search components..." data-en-placeholder="Search components..." data-zh-placeholder="ÊêúÁ¥¢ÁªÑ‰ª∂..." oninput="filterComponents(this.value)">
  </div>
  <div class="arch-container">
    <div class="arch-diagram" id="arch-svg-container">
      <svg viewBox="0 0 960 520" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <marker id="ah" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
            <polygon points="0 0, 8 3, 0 6" fill="var(--text-dim)" opacity="0.5"/>
          </marker>
        </defs>
        <!-- Arrows -->
        <path id="f1" class="flow-path" stroke="#00d4ff" d="M 460,107 L 460,198" marker-end="url(#ah)"/>
        <text class="flow-label"><textPath href="#f1" startOffset="50%" data-en="pages &amp; API" data-zh="È°µÈù¢ÂíåAPI">pages &amp; API</textPath></text>
        <path id="f2" class="flow-path" stroke="#51cf66" d="M 460,277 L 460,383" marker-end="url(#ah)"/>
        <text class="flow-label"><textPath href="#f2" startOffset="50%" data-en="SQL queries" data-zh="SQLÊü•ËØ¢">SQL queries</textPath></text>
        <path id="f3" class="flow-path" stroke="#c39eff" d="M 360,238 L 220,238" marker-end="url(#ah)"/>
        <text class="flow-label"><textPath href="#f3" startOffset="50%" data-en="verify session" data-zh="È™åËØÅ‰ºöËØù">verify session</textPath></text>
        <path id="f4" class="flow-path" stroke="#ffd43b" d="M 560,238 L 690,238" marker-end="url(#ah)"/>
        <text class="flow-label"><textPath href="#f4" startOffset="50%" data-en="send emails" data-zh="ÂèëÈÄÅÈÇÆ‰ª∂">send emails</textPath></text>
        <path id="f5" class="flow-path" stroke="#ff6b9d" d="M 540,68 C 660,30 790,60 800,198" marker-end="url(#ah)"/>
        <text class="flow-label"><textPath href="#f5" startOffset="45%" data-en="capture events" data-zh="ÊçïËé∑‰∫ã‰ª∂">capture events</textPath></text>
        <path id="f6" class="flow-path" stroke="#ff6b9d" d="M 540,258 C 660,278 790,258 800,238" marker-end="url(#ah)"/>
        <text class="flow-label"><textPath href="#f6" startOffset="45%" data-en="server events" data-zh="ÊúçÂä°Á´Ø‰∫ã‰ª∂">server events</textPath></text>
        <!-- Nodes -->
        <g class="node-group" data-id="frontend" data-name="Frontend">
          <rect class="node-rect" x="370" y="28" width="180" height="79" fill="var(--node-fill)" stroke="#00d4ff"/>
          <text class="node-label" x="460" y="56" data-en="üåê Frontend" data-zh="üåê ÂâçÁ´Ø">üåê Frontend</text>
          <text class="node-sublabel" x="460" y="78" data-en="React + Tailwind" data-zh="React + Tailwind">React + Tailwind</text>
        </g>
        <g class="node-group" data-id="server" data-name="Server">
          <rect class="node-rect" x="370" y="198" width="180" height="79" fill="var(--node-fill)" stroke="#ff6b9d"/>
          <text class="node-label" x="460" y="226" data-en="üß† Server" data-zh="üß† ÊúçÂä°Á´Ø">üß† Server</text>
          <text class="node-sublabel" x="460" y="248" data-en="Next.js 15 API" data-zh="Next.js 15 API">Next.js 15 API</text>
        </g>
        <g class="node-group" data-id="auth" data-name="Auth">
          <rect class="node-rect" x="50" y="198" width="170" height="79" fill="var(--node-fill)" stroke="#c39eff"/>
          <text class="node-label" x="135" y="226" data-en="üîí Auth" data-zh="üîí ËÆ§ËØÅ">üîí Auth</text>
          <text class="node-sublabel" x="135" y="248" data-en="Middleware + RLS" data-zh="‰∏≠Èó¥‰ª∂ + RLS">Middleware + RLS</text>
        </g>
        <g class="node-group" data-id="email" data-name="Email">
          <rect class="node-rect" x="690" y="198" width="170" height="79" fill="var(--node-fill)" stroke="#ffd43b"/>
          <text class="node-label" x="775" y="226" data-en="üìß Email" data-zh="üìß ÈÇÆ‰ª∂">üìß Email</text>
          <text class="node-sublabel" x="775" y="248" data-en="Resend" data-zh="Resend ÈÇÆ‰ª∂">Resend</text>
        </g>
        <g class="node-group" data-id="database" data-name="Database">
          <rect class="node-rect" x="370" y="383" width="180" height="79" fill="var(--node-fill)" stroke="#51cf66"/>
          <text class="node-label" x="460" y="411" data-en="üóÑÔ∏è Database" data-zh="üóÑÔ∏è Êï∞ÊçÆÂ∫ì">üóÑÔ∏è Database</text>
          <text class="node-sublabel" x="460" y="433" data-en="Supabase + PostgreSQL" data-zh="Supabase + PostgreSQL">Supabase + PostgreSQL</text>
        </g>
        <g class="node-group" data-id="analytics" data-name="Analytics">
          <rect class="node-rect" x="690" y="28" width="170" height="79" fill="var(--node-fill)" stroke="#8888aa"/>
          <text class="node-label" x="775" y="56" data-en="üìä Analytics" data-zh="üìä ÂàÜÊûê">üìä Analytics</text>
          <text class="node-sublabel" x="775" y="78" data-en="PostHog" data-zh="PostHog ÂàÜÊûê">PostHog</text>
        </g>
      </svg>
    </div>
    <div class="inline-detail" id="inline-detail">
      <button class="close-btn" onclick="closePanel()">&times;</button>
      <h2 id="panel-title"></h2>
      <div id="panel-tags"></div>
      <div class="desc" id="panel-desc"></div>
      <div class="connections" id="panel-connections"></div>
    </div>
    <div class="arch-legend">
      <div class="legend-item"><div class="legend-dot" style="background:#00d4ff"></div><span data-en="Frontend" data-zh="ÂâçÁ´Ø">Frontend</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#ff6b9d"></div><span data-en="Backend" data-zh="ÂêéÁ´Ø">Backend</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#51cf66"></div><span data-en="Database" data-zh="Êï∞ÊçÆÂ∫ì">Database</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#c39eff"></div><span data-en="Middleware" data-zh="‰∏≠Èó¥‰ª∂">Middleware</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#ffd43b"></div><span data-en="External" data-zh="Â§ñÈÉ®ÊúçÂä°">External</span></div>
      <div class="legend-item"><div class="legend-dot" style="background:#8888aa"></div><span data-en="Analytics" data-zh="ÂàÜÊûê">Analytics</span></div>
    </div>
  </div>
</section>

<!-- ========== TAB 3: HOW TO USE ========== -->
<section id="tab-howto">
  <h2 style="margin-bottom:1.2rem;color:var(--accent);font-size:1.5rem">
    <span data-en="How to Use StarQuest" data-zh="Â¶Ç‰Ωï‰ΩøÁî® StarQuest">How to Use StarQuest</span>
  </h2>
  <div class="howto-grid">
    <div class="howto-card">
      <div class="card-icon">üöÄ</div>
      <h3><span data-en="Getting Started" data-zh="ÂºÄÂßã‰ΩøÁî®">Getting Started</span></h3>
      <p><span data-en="Set up your family in minutes." data-zh="Âá†ÂàÜÈíüÂª∫Á´ãÂÆ∂Â∫≠„ÄÇ">Set up your family in minutes.</span></p>
      <ol class="steps">
        <li><span data-en="Register as a parent" data-zh="‰ª•ÂÆ∂ÈïøÊ≥®ÂÜå">Register as a parent</span></li>
        <li><span data-en="Verify email" data-zh="È™åËØÅÈÇÆÁÆ±">Verify email</span></li>
        <li><span data-en="Add children from Settings" data-zh="Âú®ËÆæÁΩÆ‰∏≠Ê∑ªÂä†Â≠©Â≠ê">Add children from Settings</span></li>
        <li><span data-en="Get 45 quests, 11 rewards, 7 levels auto!" data-zh="Ëá™Âä®Ëé∑Âæó 45 ‰ªªÂä°„ÄÅ11 Â•ñÂä±„ÄÅ7 Á≠âÁ∫ßÔºÅ">Get 45 quests, 11 rewards, 7 levels auto!</span></li>
      </ol>
    </div>
    <div class="howto-card">
      <div class="card-icon">üë®‚Äçüë©</div>
      <h3><span data-en="Parent's Daily Routine" data-zh="ÂÆ∂ÈïøÊó•Â∏∏">Parent's Daily Routine</span></h3>
      <p><span data-en="Manage quests, review requests, track progress." data-zh="ÁÆ°ÁêÜ‰ªªÂä°„ÄÅÂÆ°Ê†∏ËØ∑Ê±Ç„ÄÅË∑üË∏™ËøõÂ∫¶„ÄÇ">Manage quests, review requests, track progress.</span></p>
      <ol class="steps">
        <li><span data-en="Create/customize quests" data-zh="ÂàõÂª∫/Ëá™ÂÆö‰πâ‰ªªÂä°">Create/customize quests</span></li>
        <li><span data-en="Review star requests" data-zh="ÂÆ°Ê†∏ÊòüÊòüËØ∑Ê±Ç">Review star requests</span></li>
        <li><span data-en="Approve/reject redemptions" data-zh="ÊâπÂáÜ/ÊãíÁªùÂÖëÊç¢">Approve/reject redemptions</span></li>
        <li><span data-en="Record stars or batch actions" data-zh="ËÆ∞ÂΩïÊòüÊòüÊàñÊâπÈáèÊìç‰Ωú">Record stars or batch actions</span></li>
        <li><span data-en="Check weekly/monthly reports" data-zh="Êü•ÁúãÂë®Êä•/ÊúàÊä•">Check weekly/monthly reports</span></li>
      </ol>
    </div>
    <div class="howto-card">
      <div class="card-icon">üëß</div>
      <h3><span data-en="Child's Adventure" data-zh="Â≠©Â≠êÁöÑÂÜíÈô©">Child's Adventure</span></h3>
      <p><span data-en="Earn stars and spend on rewards!" data-zh="ËµöÊòüÊòüÊç¢Â•ñÂìÅÔºÅ">Earn stars and spend on rewards!</span></p>
      <ol class="steps">
        <li><span data-en="Browse bonus quests" data-zh="ÊµèËßàÂ•ñÂä±‰ªªÂä°">Browse bonus quests</span></li>
        <li><span data-en="Complete and tap Request Stars" data-zh="ÂÆåÊàêÂêéÁÇπÂáªÁî≥ËØ∑ÊòüÊòü">Complete and tap Request Stars</span></li>
        <li><span data-en="Add a note for parents" data-zh="ÁªôÂÆ∂ÈïøÊ∑ªÂä†Â§áÊ≥®">Add a note for parents</span></li>
        <li><span data-en="Watch balance grow!" data-zh="Áúã‰ΩôÈ¢ùÂ¢ûÈïøÔºÅ">Watch balance grow!</span></li>
        <li><span data-en="Redeem awesome rewards" data-zh="ÂÖëÊç¢Ë∂ÖÊ£íÂ•ñÂä±">Redeem awesome rewards</span></li>
      </ol>
    </div>
    <div class="howto-card">
      <div class="card-icon">üíé</div>
      <h3><span data-en="Power Features" data-zh="È´òÁ∫ßÂäüËÉΩ">Power Features</span></h3>
      <p><span data-en="Level up your experience." data-zh="ÂçáÁ∫ß‰Ω†ÁöÑ‰ΩìÈ™å„ÄÇ">Level up your experience.</span></p>
      <ol class="steps">
        <li><span data-en="üí≥ Credit ‚Äî borrow stars with interest" data-zh="üí≥ ‰ø°Áî® ‚Äî ÂÄüÊòüÊòüÊúâÂà©ÊÅØ">üí≥ Credit ‚Äî borrow stars with interest</span></li>
        <li><span data-en="üìä On-demand reports (daily-yearly)" data-zh="üìä ÊåâÈúÄÊä•ÂëäÔºàÊó•Êä•Âà∞Âπ¥Êä•Ôºâ">üìä On-demand reports (daily-yearly)</span></li>
        <li><span data-en="üè∑Ô∏è Custom quest categories" data-zh="üè∑Ô∏è Ëá™ÂÆö‰πâ‰ªªÂä°Á±ªÂà´">üè∑Ô∏è Custom quest categories</span></li>
        <li><span data-en="üë• Invite co-parent via email" data-zh="üë• ÈÇÆ‰ª∂ÈÇÄËØ∑Âè¶‰∏ÄÂÆ∂Èïø">üë• Invite co-parent via email</span></li>
        <li><span data-en="üìÖ Calendar activity view" data-zh="üìÖ Êó•ÂéÜÊ¥ªÂä®ËßÜÂõæ">üìÖ Calendar activity view</span></li>
      </ol>
    </div>
    <div class="howto-card">
      <div class="card-icon">üåê</div>
      <h3><span data-en="Bilingual Support" data-zh="ÂèåËØ≠ÊîØÊåÅ">Bilingual Support</span></h3>
      <p><span data-en="English and Chinese with one click." data-zh="‰∏ÄÈîÆÂàáÊç¢‰∏≠Ëã±Êñá„ÄÇ">English and Chinese with one click.</span></p>
      <ol class="steps">
        <li><span data-en="Toggle language from top menu" data-zh="‰ªéÈ°∂ÈÉ®ËèúÂçïÂàáÊç¢ËØ≠Ë®Ä">Toggle language from top menu</span></li>
        <li><span data-en="Quests have name_en + name_zh" data-zh="‰ªªÂä°Êúâ name_en + name_zh">Quests have name_en + name_zh</span></li>
        <li><span data-en="Reports respect your preference" data-zh="Êä•ÂëäÈÅµÂæ™‰Ω†ÁöÑËØ≠Ë®ÄÂÅèÂ•Ω">Reports respect your preference</span></li>
      </ol>
    </div>
    <div class="howto-card">
      <div class="card-icon">üé≠</div>
      <h3><span data-en="Try the Demo" data-zh="ËØïÁé©ÊºîÁ§∫">Try the Demo</span></h3>
      <p><span data-en="Explore instantly ‚Äî no registration!" data-zh="Á´ãÂç≥‰ΩìÈ™å ‚Äî Êó†ÈúÄÊ≥®ÂÜåÔºÅ">Explore instantly ‚Äî no registration!</span></p>
      <ol class="steps">
        <li><span data-en="Click 'Try Demo' on login page" data-zh="Âú®ÁôªÂΩïÈ°µÁÇπ"ËØïÁé©ÊºîÁ§∫"">Click 'Try Demo' on login page</span></li>
        <li><span data-en="Pick: Parent, Alisa, or Alexander" data-zh="ÈÄâËßíËâ≤ÔºöÂÆ∂Èïø„ÄÅAlisa Êàñ Alexander">Pick: Parent, Alisa, or Alexander</span></li>
        <li><span data-en="Explore 30 days of real data" data-zh="Êé¢Á¥¢ 30 Â§©ÁúüÂÆûÊï∞ÊçÆ">Explore 30 days of real data</span></li>
        <li><span data-en="Magic link login ‚Äî no password" data-zh="È≠îÊ≥ïÈìæÊé•ÁôªÂΩï ‚Äî Êó†ÈúÄÂØÜÁ†Å">Magic link login ‚Äî no password</span></li>
      </ol>
    </div>
  </div>
</section>

<!-- ========== TAB 4: DATA FLOW ========== -->
<section id="tab-dataflow">
  <h2 style="margin-bottom:1.2rem;color:var(--accent);font-size:1.5rem">
    <span data-en="How Data Flows Through StarQuest" data-zh="Êï∞ÊçÆÂ¶Ç‰ΩïÂú® StarQuest ‰∏≠ÊµÅÂä®">How Data Flows Through StarQuest</span>
  </h2>
  <div class="arch-diagram" id="dataflow-svg-container">
    <svg viewBox="0 0 960 640" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="da" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
          <polygon points="0 0, 8 3, 0 6" fill="var(--text-dim)" opacity="0.5"/>
        </marker>
      </defs>
      <!-- FLOW 1: Star Request -->
      <text x="480" y="22" fill="#00d4ff" font-size="16" font-weight="bold" text-anchor="middle" data-en="‚≠ê Quest Star Request Flow" data-zh="‚≠ê ‰ªªÂä°ÊòüÊòüÁî≥ËØ∑ÊµÅÁ®ã">‚≠ê Quest Star Request Flow</text>
      <rect x="30" y="42" width="110" height="55" rx="10" fill="var(--node-fill)" stroke="#00d4ff" stroke-width="2"/>
      <text x="85" y="63" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üëß Child" data-zh="üëß Â≠©Â≠ê">üëß Child</text>
      <text x="85" y="81" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="taps Request" data-zh="ÁÇπÂáªÁî≥ËØ∑">taps Request</text>
      <path id="d1" class="flow-path" stroke="#00d4ff" d="M 140,70 L 180,70" marker-end="url(#da)"/>
      <rect x="180" y="42" width="120" height="55" rx="10" fill="var(--node-fill)" stroke="#00d4ff" stroke-width="2"/>
      <text x="240" y="63" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üåê Frontend" data-zh="üåê ÂâçÁ´Ø">üåê Frontend</text>
      <text x="240" y="81" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="form + validate" data-zh="Ë°®ÂçïÈ™åËØÅ">form + validate</text>
      <path id="d2" class="flow-path" stroke="#ff6b9d" d="M 300,70 L 340,70" marker-end="url(#da)"/>
      <rect x="340" y="42" width="120" height="55" rx="10" fill="var(--node-fill)" stroke="#ff6b9d" stroke-width="2"/>
      <text x="400" y="63" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üß† Server" data-zh="üß† ÊúçÂä°Á´Ø">üß† Server</text>
      <text x="400" y="81" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="API route" data-zh="API Ë∑ØÁî±">API route</text>
      <path id="d3" class="flow-path" stroke="#51cf66" d="M 460,70 L 500,70" marker-end="url(#da)"/>
      <rect x="500" y="42" width="130" height="55" rx="10" fill="var(--node-fill)" stroke="#51cf66" stroke-width="2"/>
      <text x="565" y="63" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üóÑÔ∏è Database" data-zh="üóÑÔ∏è Êï∞ÊçÆÂ∫ì">üóÑÔ∏è Database</text>
      <text x="565" y="81" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="INSERT pending" data-zh="INSERT ÂæÖÂÆ°Êâπ">INSERT pending</text>
      <path id="d4" class="flow-path" stroke="#ffd43b" d="M 630,70 L 670,70" marker-end="url(#da)"/>
      <rect x="670" y="42" width="130" height="55" rx="10" fill="var(--node-fill)" stroke="#ffd43b" stroke-width="2"/>
      <text x="735" y="63" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üë®‚Äçüë© Parent" data-zh="üë®‚Äçüë© ÂÆ∂Èïø">üë®‚Äçüë© Parent</text>
      <text x="735" y="81" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="approve" data-zh="ÊâπÂáÜ">approve</text>
      <path id="d5" class="flow-path" stroke="#51cf66" d="M 800,70 L 840,70" marker-end="url(#da)"/>
      <rect x="840" y="42" width="100" height="55" rx="10" fill="var(--node-fill)" stroke="#FFD700" stroke-width="2"/>
      <text x="890" y="63" fill="#FFD700" font-size="13" font-weight="600" text-anchor="middle" data-en="‚≠ê +15" data-zh="‚≠ê +15">‚≠ê +15</text>
      <text x="890" y="81" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="balance updated" data-zh="‰ΩôÈ¢ùÊõ¥Êñ∞">balance updated</text>

      <!-- FLOW 2: Reward Redemption -->
      <text x="480" y="152" fill="#51cf66" font-size="16" font-weight="bold" text-anchor="middle" data-en="üéÅ Reward Redemption Flow" data-zh="üéÅ Â•ñÂä±ÂÖëÊç¢ÊµÅÁ®ã">üéÅ Reward Redemption Flow</text>
      <rect x="80" y="172" width="120" height="55" rx="10" fill="var(--node-fill)" stroke="#51cf66" stroke-width="2"/>
      <text x="140" y="193" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üëß Child" data-zh="üëß Â≠©Â≠ê">üëß Child</text>
      <text x="140" y="211" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="picks reward" data-zh="ÈÄâÊã©Â•ñÂä±">picks reward</text>
      <path id="d6" class="flow-path" stroke="#51cf66" d="M 200,200 L 260,200" marker-end="url(#da)"/>
      <rect x="260" y="172" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#51cf66" stroke-width="2"/>
      <text x="330" y="193" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üóÑÔ∏è redemptions" data-zh="üóÑÔ∏è ÂÖëÊç¢Ë°®">üóÑÔ∏è redemptions</text>
      <text x="330" y="211" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="INSERT pending" data-zh="INSERT ÂæÖÂÆ°Êâπ">INSERT pending</text>
      <path id="d7" class="flow-path" stroke="#ffd43b" d="M 400,200 L 460,200" marker-end="url(#da)"/>
      <rect x="460" y="172" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#ffd43b" stroke-width="2"/>
      <text x="530" y="193" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üë®‚Äçüë© Parent" data-zh="üë®‚Äçüë© ÂÆ∂Èïø">üë®‚Äçüë© Parent</text>
      <text x="530" y="211" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="approve + date" data-zh="ÊâπÂáÜ + ËÆæÊó•Êúü">approve + date</text>
      <path id="d8" class="flow-path" stroke="#51cf66" d="M 600,200 L 660,200" marker-end="url(#da)"/>
      <rect x="660" y="172" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#FFD700" stroke-width="2"/>
      <text x="730" y="193" fill="#FFD700" font-size="13" font-weight="600" text-anchor="middle" data-en="üí∞ -50 stars" data-zh="üí∞ -50 Êòü">üí∞ -50 stars</text>
      <text x="730" y="211" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="balance deducted" data-zh="‰ΩôÈ¢ùÊâ£Èô§">balance deducted</text>

      <!-- FLOW 3: Auth -->
      <text x="480" y="282" fill="#c39eff" font-size="16" font-weight="bold" text-anchor="middle" data-en="üîí Authentication Flow" data-zh="üîí ËÆ§ËØÅÊµÅÁ®ã">üîí Authentication Flow</text>
      <rect x="30" y="302" width="110" height="55" rx="10" fill="var(--node-fill)" stroke="#c39eff" stroke-width="2"/>
      <text x="85" y="323" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üë§ User" data-zh="üë§ Áî®Êà∑">üë§ User</text>
      <text x="85" y="341" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="login" data-zh="ÁôªÂΩï">login</text>
      <path id="d9" class="flow-path" stroke="#c39eff" d="M 140,330 L 190,330" marker-end="url(#da)"/>
      <rect x="190" y="302" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#c39eff" stroke-width="2"/>
      <text x="260" y="323" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üîê Supabase Auth" data-zh="üîê Supabase ËÆ§ËØÅ">üîê Supabase Auth</text>
      <text x="260" y="341" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="verify credentials" data-zh="È™åËØÅÂá≠ÊçÆ">verify credentials</text>
      <path id="d10" class="flow-path" stroke="#c39eff" d="M 330,330 L 380,330" marker-end="url(#da)"/>
      <rect x="380" y="302" width="130" height="55" rx="10" fill="var(--node-fill)" stroke="#c39eff" stroke-width="2"/>
      <text x="445" y="323" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üç™ Session" data-zh="üç™ ‰ºöËØù">üç™ Session</text>
      <text x="445" y="341" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="cookie set" data-zh="ËÆæÁΩÆcookie">cookie set</text>
      <path id="d11" class="flow-path" stroke="#c39eff" d="M 510,330 L 560,330" marker-end="url(#da)"/>
      <rect x="560" y="302" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#ff6b9d" stroke-width="2"/>
      <text x="630" y="323" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üõ°Ô∏è Middleware" data-zh="üõ°Ô∏è ‰∏≠Èó¥‰ª∂">üõ°Ô∏è Middleware</text>
      <text x="630" y="341" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="role -> route" data-zh="ËßíËâ≤ -> Ë∑ØÁî±">role -> route</text>
      <path id="d12" class="flow-path" stroke="#00d4ff" d="M 700,330 L 750,330" marker-end="url(#da)"/>
      <rect x="750" y="302" width="120" height="55" rx="10" fill="var(--node-fill)" stroke="#00d4ff" stroke-width="2"/>
      <text x="810" y="323" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üì± App" data-zh="üì± Â∫îÁî®">üì± App</text>
      <text x="810" y="341" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="/admin or /app" data-zh="/admin Êàñ /app">/admin or /app</text>

      <!-- FLOW 4: Reports -->
      <text x="480" y="412" fill="#ffd43b" font-size="16" font-weight="bold" text-anchor="middle" data-en="üìß Automated Report Flow" data-zh="üìß Ëá™Âä®Êä•ÂëäÊµÅÁ®ã">üìß Automated Report Flow</text>
      <rect x="80" y="432" width="120" height="55" rx="10" fill="var(--node-fill)" stroke="#ffd43b" stroke-width="2"/>
      <text x="140" y="453" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="‚è∞ Cron" data-zh="‚è∞ ÂÆöÊó∂‰ªªÂä°">‚è∞ Cron</text>
      <text x="140" y="471" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="daily trigger" data-zh="ÊØèÊó•Ëß¶Âèë">daily trigger</text>
      <path id="d13" class="flow-path" stroke="#ffd43b" d="M 200,460 L 260,460" marker-end="url(#da)"/>
      <rect x="260" y="432" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#51cf66" stroke-width="2"/>
      <text x="330" y="453" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üóÑÔ∏è Fetch Data" data-zh="üóÑÔ∏è Ëé∑ÂèñÊï∞ÊçÆ">üóÑÔ∏è Fetch Data</text>
      <text x="330" y="471" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="stars + redemptions" data-zh="ÊòüÊòü + ÂÖëÊç¢">stars + redemptions</text>
      <path id="d14" class="flow-path" stroke="#ff6b9d" d="M 400,460 L 460,460" marker-end="url(#da)"/>
      <rect x="460" y="432" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#ff6b9d" stroke-width="2"/>
      <text x="530" y="453" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üìù Build Stats" data-zh="üìù ÁîüÊàêÁªüËÆ°">üìù Build Stats</text>
      <text x="530" y="471" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="per-child summary" data-zh="ÊåâÂ≠©Â≠êÊ±áÊÄª">per-child summary</text>
      <path id="d15" class="flow-path" stroke="#ffd43b" d="M 600,460 L 660,460" marker-end="url(#da)"/>
      <rect x="660" y="432" width="140" height="55" rx="10" fill="var(--node-fill)" stroke="#ffd43b" stroke-width="2"/>
      <text x="730" y="453" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üìß Resend" data-zh="üìß ÂèëÈÄÅÈÇÆ‰ª∂">üìß Resend</text>
      <text x="730" y="471" fill="var(--node-sublabel)" font-size="11" text-anchor="middle" data-en="email to parents" data-zh="ÈÇÆ‰ª∂ÁªôÂÆ∂Èïø">email to parents</text>

      <!-- FLOW 5: Credit -->
      <text x="480" y="542" fill="#FBBF24" font-size="16" font-weight="bold" text-anchor="middle" data-en="üí≥ Credit System Flow" data-zh="üí≥ ‰ø°Áî®Á≥ªÁªüÊµÅÁ®ã">üí≥ Credit System Flow</text>
      <rect x="80" y="560" width="120" height="44" rx="10" fill="var(--node-fill)" stroke="#FBBF24" stroke-width="2"/>
      <text x="140" y="586" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üí≥ Borrow" data-zh="üí≥ ÂÄüÊòüÊòü">üí≥ Borrow</text>
      <path id="d16" class="flow-path" stroke="#FBBF24" d="M 200,582 L 260,582" marker-end="url(#da)"/>
      <rect x="260" y="560" width="140" height="44" rx="10" fill="var(--node-fill)" stroke="#FBBF24" stroke-width="2"/>
      <text x="330" y="586" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üìà Interest" data-zh="üìà Âà©ÊÅØ">üìà Interest</text>
      <path id="d17" class="flow-path" stroke="#FBBF24" d="M 400,582 L 460,582" marker-end="url(#da)"/>
      <rect x="460" y="560" width="140" height="44" rx="10" fill="var(--node-fill)" stroke="#FBBF24" stroke-width="2"/>
      <text x="530" y="586" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="‚è∞ Settle" data-zh="‚è∞ ÁªìÁÆó">‚è∞ Settle</text>
      <path id="d18" class="flow-path" stroke="#FBBF24" d="M 600,582 L 660,582" marker-end="url(#da)"/>
      <rect x="660" y="560" width="140" height="44" rx="10" fill="var(--node-fill)" stroke="#51cf66" stroke-width="2"/>
      <text x="730" y="586" fill="var(--node-label)" font-size="13" font-weight="600" text-anchor="middle" data-en="üí∞ Updated" data-zh="üí∞ Êõ¥Êñ∞">üí∞ Updated</text>
    </svg>
  </div>
</section>

<!-- ========== TAB 5: QUALITY & SECURITY ========== -->
<section id="tab-quality">
  <h2 style="margin-bottom:1.2rem;color:var(--accent);font-size:1.5rem">
    <span data-en="Quality &amp; Security" data-zh="Ë¥®Èáè‰∏éÂÆâÂÖ®">Quality &amp; Security</span>
  </h2>

  <div class="quality-section">
    <h3><span data-en="Test Coverage" data-zh="ÊµãËØïË¶ÜÁõñ">Test Coverage</span></h3>
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-value">2,849</div>
        <div class="stat-label"><span data-en="Tests Passing" data-zh="ÊµãËØïÈÄöËøá">Tests Passing</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-value">~99%</div>
        <div class="stat-label"><span data-en="Code Coverage" data-zh="‰ª£Á†ÅË¶ÜÁõñÁéá">Code Coverage</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-value">Jest</div>
        <div class="stat-label"><span data-en="+ React Testing Library" data-zh="+ React Testing Library">+ React Testing Library</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-value">TDD</div>
        <div class="stat-label"><span data-en="Red ‚Üí Green ‚Üí Refactor" data-zh="Á∫¢ ‚Üí Áªø ‚Üí ÈáçÊûÑ">Red ‚Üí Green ‚Üí Refactor</span></div>
      </div>
    </div>
  </div>

  <div class="quality-section">
    <h3><span data-en="Security Features" data-zh="ÂÆâÂÖ®ÁâπÊÄß">Security Features</span></h3>
    <div class="security-grid">
      <div class="security-card">
        <div class="sec-icon">üõ°Ô∏è</div>
        <h4><span data-en="Row-Level Security" data-zh="Ë°åÁ∫ßÂÆâÂÖ®">Row-Level Security</span></h4>
        <p><span data-en="Every table uses family_id with PostgreSQL RLS. Each family can only access their own data ‚Äî enforced at the database level." data-zh="ÊØèÂº†Ë°®Áî® family_id ÈÖçÂêà PostgreSQL RLS„ÄÇÊØèÂÆ∂Âè™ËÉΩËÆøÈóÆËá™Â∑±ÁöÑÊï∞ÊçÆ ‚Äî Êï∞ÊçÆÂ∫ìÂ±ÇÈù¢Âº∫Âà∂ÊâßË°å„ÄÇ">Every table uses family_id with PostgreSQL RLS. Each family can only access their own data ‚Äî enforced at the database level.</span></p>
      </div>
      <div class="security-card">
        <div class="sec-icon">üîí</div>
        <h4><span data-en="Middleware Auth" data-zh="‰∏≠Èó¥‰ª∂ËÆ§ËØÅ">Middleware Auth</span></h4>
        <p><span data-en="Intl middleware runs first, then Supabase session check. This order is critical ‚Äî reversing it breaks sessions." data-zh="ÂõΩÈôÖÂåñ‰∏≠Èó¥‰ª∂ÂÖàËøêË°åÔºåÁÑ∂ÂêéÊ£ÄÊü• Supabase ‰ºöËØù„ÄÇÊ≠§È°∫Â∫èËá≥ÂÖ≥ÈáçË¶Å ‚Äî ÂèçËΩ¨‰ºöÁ†¥Âùè‰ºöËØù„ÄÇ">Intl middleware runs first, then Supabase session check. This order is critical ‚Äî reversing it breaks sessions.</span></p>
      </div>
      <div class="security-card">
        <div class="sec-icon">üë•</div>
        <h4><span data-en="Role-Based Access" data-zh="Âü∫‰∫éËßíËâ≤ÁöÑËÆøÈóÆÊéßÂà∂">Role-Based Access</span></h4>
        <p><span data-en="Parents route to /admin, children to /app. requireParent() and requireAuth() guards protect every route." data-zh="ÂÆ∂ÈïøË∑ØÁî±Âà∞ /adminÔºåÂ≠©Â≠êÂà∞ /app„ÄÇrequireParent() Âíå requireAuth() ÂÆàÂç´‰øùÊä§ÊØè‰∏™Ë∑ØÁî±„ÄÇ">Parents route to /admin, children to /app. requireParent() and requireAuth() guards protect every route.</span></p>
      </div>
      <div class="security-card">
        <div class="sec-icon">üîê</div>
        <h4><span data-en="Privacy-First Analytics" data-zh="ÈöêÁßÅ‰ºòÂÖàÂàÜÊûê">Privacy-First Analytics</span></h4>
        <p><span data-en="Children identified by UUID only ‚Äî no email, no name. Session recordings disabled for all child accounts." data-zh="ÂÑøÁ´•‰ªÖÁî® UUID Ê†áËØÜ ‚Äî Êó†ÈÇÆÁÆ±„ÄÅÊó†ÂßìÂêç„ÄÇÊâÄÊúâÂÑøÁ´•Ë¥¶Êà∑Á¶ÅÁî®‰ºöËØùÂΩïÂà∂„ÄÇ">Children identified by UUID only ‚Äî no email, no name. Session recordings disabled for all child accounts.</span></p>
      </div>
      <div class="security-card">
        <div class="sec-icon">‚ö°</div>
        <h4><span data-en="SECURITY DEFINER" data-zh="SECURITY DEFINER ÂáΩÊï∞">SECURITY DEFINER</span></h4>
        <p><span data-en="Sensitive operations (password reset, email update, child delete) run via SECURITY DEFINER functions ‚Äî never exposed to client." data-zh="ÊïèÊÑüÊìç‰ΩúÔºàÂØÜÁ†ÅÈáçÁΩÆ„ÄÅÈÇÆÁÆ±Êõ¥Êñ∞„ÄÅÂà†Èô§Â≠©Â≠êÔºâÈÄöËøá SECURITY DEFINER ÂáΩÊï∞ËøêË°å ‚Äî ‰ªé‰∏çÊö¥Èú≤ÁªôÂÆ¢Êà∑Á´Ø„ÄÇ">Sensitive operations (password reset, email update, child delete) run via SECURITY DEFINER functions ‚Äî never exposed to client.</span></p>
      </div>
      <div class="security-card">
        <div class="sec-icon">üç™</div>
        <h4><span data-en="Cookie-Based Sessions" data-zh="Âü∫‰∫éCookieÁöÑ‰ºöËØù">Cookie-Based Sessions</span></h4>
        <p><span data-en="httpOnly cookies via @supabase/ssr. Post-auth uses window.location.href (not router.push) to avoid login loops." data-zh="ÈÄöËøá @supabase/ssr ‰ΩøÁî® httpOnly cookie„ÄÇÁôªÂΩïÂêéÁî® window.location.hrefÔºàÈùû router.pushÔºâÈÅøÂÖçÁôªÂΩïÂæ™ÁéØ„ÄÇ">httpOnly cookies via @supabase/ssr. Post-auth uses window.location.href (not router.push) to avoid login loops.</span></p>
      </div>
    </div>
  </div>

  <div class="quality-section">
    <h3><span data-en="Code Quality" data-zh="‰ª£Á†ÅË¥®Èáè">Code Quality</span></h3>
    <div class="badge-row">
      <span class="quality-badge"><span data-en="TypeScript strict" data-zh="TypeScript ‰∏•Ê†ºÊ®°Âºè">TypeScript strict</span></span>
      <span class="quality-badge"><span data-en="TDD workflow" data-zh="TDD Â∑•‰ΩúÊµÅ">TDD workflow</span></span>
      <span class="quality-badge"><span data-en="Bilingual EN/‰∏≠Êñá" data-zh="ÂèåËØ≠ EN/‰∏≠Êñá">Bilingual EN/‰∏≠Êñá</span></span>
      <span class="quality-badge"><span data-en="~99% coverage" data-zh="~99% Ë¶ÜÁõñÁéá">~99% coverage</span></span>
      <span class="quality-badge"><span data-en="Every component tested" data-zh="ÊØè‰∏™ÁªÑ‰ª∂ÈÉΩÊúâÊµãËØï">Every component tested</span></span>
      <span class="quality-badge"><span data-en="Family-scoped RLS" data-zh="ÂÆ∂Â∫≠ËåÉÂõ¥ RLS">Family-scoped RLS</span></span>
    </div>
  </div>
</section>

<!-- ========== TAB 6: STAR ECONOMY ========== -->
<section id="tab-economy">
  <h2 style="margin-bottom:1.2rem;color:var(--accent);font-size:1.5rem">
    <span data-en="Featured Functions" data-zh="ÁâπËâ≤ÂäüËÉΩ">Featured Functions</span> üí∞
  </h2>
  <p style="color:var(--text-dim);margin-bottom:1.5rem;font-size:0.95rem">
    <span data-en="Different quests earn (or lose!) different amounts of stars. Click any cell to learn more!" data-zh="‰∏çÂêå‰ªªÂä°ËµöÂèñÔºàÊàñÂ§±ÂéªÔºÅÔºâ‰∏çÂêåÊï∞ÈáèÁöÑÊòüÊòü„ÄÇÁÇπÂáª‰ªªÊÑèÂçïÂÖÉÊ†º‰∫ÜËß£Êõ¥Â§öÔºÅ">Different quests earn (or lose!) different amounts of stars. Click any cell to learn more!</span>
  </p>

  <div id="economy-grid" style="position:relative">
    <!-- Quest Matrix -->
    <div>
      <h3 style="color:var(--text);margin-bottom:16px;font-size:1rem;font-weight:700">
        <span data-en="Quest Matrix ‚Äî Stars by Type √ó Scope" data-zh="‰ªªÂä°Áü©Èòµ ‚Äî Á±ªÂûã √ó ËåÉÂõ¥ÁöÑÊòüÊòüÂØπÁÖßË°®">Quest Matrix ‚Äî Stars by Type √ó Scope</span>
      </h3>
      <div id="quest-matrix"><!-- Filled by JS --></div>
      <p style="font-size:0.88rem;color:var(--text-dim);margin-top:12px">
        <span data-en="üëÜ Click any cell to see details" data-zh="üëÜ ÁÇπÂáª‰ªªÊÑèÂçïÂÖÉÊ†ºÊü•ÁúãËØ¶ÊÉÖ">üëÜ Click any cell to see details</span>
      </p>
    </div>

    <!-- Star Flow + Credit -->
    <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
      <h3 style="color:var(--text);margin-bottom:8px;font-size:1rem;font-weight:700;align-self:flex-start">
        <span data-en="Star Flow Diagram" data-zh="ÊòüÊòüÊµÅÂä®Âõæ">Star Flow Diagram</span>
      </h3>

      <div id="star-flow">
        <div class="econ-flow-node econ-flow-node-earn">
          <span data-en="‚≠ê Earn Stars" data-zh="‚≠ê ËµöÂèñÊòüÊòü">‚≠ê Earn Stars</span>
          <div style="font-size:0.88rem;opacity:0.7;font-weight:400;margin-top:4px">
            <span data-en="Complete quests ‚Üí parent approves" data-zh="ÂÆåÊàê‰ªªÂä° ‚Üí ÂÆ∂ÈïøÊâπÂáÜ">Complete quests ‚Üí parent approves</span>
          </div>
        </div>
        <div class="econ-flow-arrow">‚Üì</div>
        <div class="econ-flow-node econ-flow-node-balance">
          <span data-en="üí∞ Star Balance" data-zh="üí∞ ÊòüÊòü‰ΩôÈ¢ù">üí∞ Star Balance</span>
          <div style="font-size:0.88rem;opacity:0.7;font-weight:400;margin-top:4px">child_balances VIEW</div>
        </div>
        <div class="econ-flow-arrow">‚Üì</div>
        <div class="econ-flow-node econ-flow-node-reward">
          <span data-en="üéÅ Redeem Reward" data-zh="üéÅ ÂÖëÊç¢Â•ñÂä±">üéÅ Redeem Reward</span>
          <div style="font-size:0.88rem;opacity:0.7;font-weight:400;margin-top:4px">
            <span data-en="Stars deducted ‚Üí parent confirms" data-zh="Êâ£Èô§ÊòüÊòü ‚Üí ÂÆ∂ÈïøÁ°ÆËÆ§">Stars deducted ‚Üí parent confirms</span>
          </div>
        </div>
      </div>

      <div id="credit-mini">
        <h4><span data-en="üí≥ Credit System" data-zh="üí≥ ‰ø°Áî®Á≥ªÁªü">üí≥ Credit System</span></h4>
        <p><span data-en="Like a piggy bank loan! Kids can borrow stars when they run low. Each month, a small interest charge is automatically settled." data-zh="ÂÉèÂ∞èÁå™Â≠òÈí±ÁΩêË¥∑Ê¨æÔºÅÂ≠©Â≠êÊòüÊòü‰∏çÂ§üÊó∂ÂèØ‰ª•ÂÄü„ÄÇÊØèÊúàËá™Âä®ÁªìÁÆóÂ∞ëÈáèÂà©ÊÅØ„ÄÇ">Like a piggy bank loan! Kids can borrow stars when they run low. Each month, a small interest charge is automatically settled.</span> üè¶</p>
        <div style="margin-top:8px;font-size:0.88rem;color:var(--accent2)">
          Tables: <code>credit_settings</code> ¬∑ <code>credit_transactions</code> ¬∑ <code>interest_tiers</code>
        </div>
      </div>
    </div>
  </div>

  <!-- Matrix Tooltip -->
  <div id="matrix-tooltip"></div>
</section>

<!-- ========== TAB 7: DATABASE ========== -->
<section id="tab-database">
  <h2 style="margin-bottom:1.2rem;color:var(--accent);font-size:1.5rem">
    <span data-en="The Database Memory" data-zh="Êï∞ÊçÆÂ∫ìËÆ∞ÂøÜ">The Database Memory</span> üóÑÔ∏è
  </h2>
  <p style="color:var(--text-dim);margin-bottom:1.5rem;font-size:0.95rem">
    <span data-en="Everything in StarQuest is saved in a PostgreSQL database. Tables hold the data, and arrows show how they connect!" data-zh="StarQuest ÁöÑ‰∏ÄÂàáÈÉΩ‰øùÂ≠òÂú® PostgreSQL Êï∞ÊçÆÂ∫ì‰∏≠„ÄÇË°®Ê†ºÂ≠òÂÇ®Êï∞ÊçÆÔºåÁÆ≠Â§¥ÊòæÁ§∫ÂÆÉ‰ª¨Â¶Ç‰ΩïËøûÊé•ÔºÅ">Everything in StarQuest is saved in a PostgreSQL database. Tables hold the data, and arrows show how they connect!</span>
  </p>

  <!-- Schema Tables -->
  <div id="schema-tables"><!-- Filled by JS --></div>

  <!-- RLS Banner -->
  <div class="db-rls-banner">
    üîí <strong>Row-Level Security (RLS):</strong>
    <span data-en="Every table has a magic shield ‚Äî you can only read or write data that belongs to your own family. Even if someone guessed another family's ID, the database refuses! This is built right into PostgreSQL." data-zh="ÊØèÂº†Ë°®ÈÉΩÊúâ‰∏Ä‰∏™È≠îÊ≥ïÁõæÁâå ‚Äî ‰Ω†Âè™ËÉΩËØªÂÜôÂ±û‰∫é‰Ω†Ëá™Â∑±ÂÆ∂Â∫≠ÁöÑÊï∞ÊçÆ„ÄÇÂç≥‰ΩøÊúâ‰∫∫ÁåúÂà∞‰∫ÜÂÖ∂‰ªñÂÆ∂Â∫≠ÁöÑ IDÔºåÊï∞ÊçÆÂ∫ì‰πü‰ºöÊãíÁªùÔºÅËøôÁõ¥Êé•ÂÜÖÁΩÆ‰∫é PostgreSQL ‰∏≠„ÄÇ">Every table has a magic shield ‚Äî you can only read or write data that belongs to your own family. Even if someone guessed another family's ID, the database refuses! This is built right into PostgreSQL.</span>
  </div>

  <!-- Interactive Demo -->
  <div id="db-demo">
    <h3 style="color:var(--text);font-size:1rem;font-weight:700">
      <span data-en="üéÆ Interactive Demo ‚Äî Try it yourself!" data-zh="üéÆ ‰∫íÂä®ÊºîÁ§∫ ‚Äî ‰∫≤Ëá™ËØïËØïÔºÅ">üéÆ Interactive Demo ‚Äî Try it yourself!</span>
    </h3>
    <div id="db-demo-btns">
      <button class="db-demo-btn db-demo-btn-insert" onclick="dbDemoInsert()">
        <span data-en="‚ûï Alisa completes a quest" data-zh="‚ûï Alisa ÂÆåÊàê‰∫Ü‰∏Ä‰∏™‰ªªÂä°">‚ûï Alisa completes a quest</span>
      </button>
      <button class="db-demo-btn db-demo-btn-approve" onclick="dbDemoApprove()" id="btn-approve" disabled>
        <span data-en="‚úÖ Parent approves it" data-zh="‚úÖ ÂÆ∂ÈïøÊâπÂáÜ‰∫Ü">‚úÖ Parent approves it</span>
      </button>
    </div>

    <div id="db-live-table">
      <div id="db-live-table-header">
        <div>id</div>
        <div><span data-en="description" data-zh="ÊèèËø∞">description</span></div>
        <div><span data-en="stars" data-zh="ÊòüÊòü">stars</span></div>
        <div><span data-en="status" data-zh="Áä∂ÊÄÅ">status</span></div>
        <div><span data-en="child" data-zh="Â≠©Â≠ê">child</span></div>
      </div>
      <div id="db-live-rows"><!-- Rows inserted by JS --></div>
    </div>

    <div id="db-balance-display">
      <span id="db-balance-label"><span data-en="‚≠ê Alisa's Balance:" data-zh="‚≠ê Alisa ÁöÑ‰ΩôÈ¢ùÔºö">‚≠ê Alisa's Balance:</span></span>
      <span id="db-balance-value">265</span>
      <span style="color:var(--text-dim);font-size:0.8rem"><span data-en="stars" data-zh="Êòü">stars</span></span>
    </div>
  </div>
</section>
</main>

<div class="tooltip" id="tooltip"></div>

<!-- Footer -->
<footer>
  <div class="brand">‚≠ê StarQuest ¬∑ Beluga Tempo ¬∑ È≤∏Âæã</div>
  <div><span data-en="A gamified family behavior tracking app ‚Äî Next.js 15 + Supabase" data-zh="Ê∏∏ÊàèÂåñÂÆ∂Â∫≠Ë°å‰∏∫ËøΩË∏™ ‚Äî Next.js 15 + Supabase">A gamified family behavior tracking app ‚Äî Next.js 15 + Supabase</span></div>
  <div style="margin-top:8px">
    <a id="try-cta" href="https://starquest.beluga-tempo.com/en" target="_blank">Try it now!</a>
    ¬∑ 2,849 tests ¬∑ ~99% coverage
  </div>
</footer>

<script>
var currentLang = 'en';
function toggleLang() {
  currentLang = currentLang === 'en' ? 'zh' : 'en';
  document.querySelectorAll('[data-en]').forEach(function(el) {
    el.textContent = el.getAttribute('data-' + currentLang);
  });
  document.querySelectorAll('[data-en-placeholder]').forEach(function(el) {
    el.placeholder = el.getAttribute('data-' + currentLang + '-placeholder');
  });
}

function toggleTheme() {
  var html = document.documentElement;
  var next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  document.getElementById('theme-btn').textContent = next === 'dark' ? 'üåô' : '‚òÄÔ∏è';
}

function createStars() {
  var c = document.getElementById('starry-bg');
  if (!c) return;
  while (c.firstChild) c.removeChild(c.firstChild);
  for (var i = 0; i < 55; i++) {
    var s = document.createElement('div');
    s.className = Math.random() > 0.3 ? 'star dim' : 'star';
    s.style.left = Math.random() * 100 + '%';
    s.style.top = Math.random() * 100 + '%';
    s.style.setProperty('--dur', (2 + Math.random() * 4) + 's');
    s.style.animationDelay = Math.random() * 3 + 's';
    c.appendChild(s);
  }
  [{x:'20%',y:'15%',sz:'300px',col:'#5a4a9a'},{x:'70%',y:'60%',sz:'350px',col:'#4a3a8a'},{x:'50%',y:'85%',sz:'250px',col:'#5a5aa0'}].forEach(function(n) {
    var el = document.createElement('div');
    el.className = 'nebula';
    el.style.cssText = 'left:'+n.x+';top:'+n.y+';width:'+n.sz+';height:'+n.sz+';background:'+n.col;
    c.appendChild(el);
  });
}

function switchTab(tab) {
  document.querySelectorAll('section').forEach(function(s) { s.classList.remove('active'); });
  document.querySelectorAll('nav .tabs button').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('tab-' + tab).classList.add('active');
  document.querySelector('[data-tab="' + tab + '"]').classList.add('active');
  closePanel();
}

document.addEventListener('click', function(e) {
  var step = e.target.closest('.story-step');
  if (step) step.classList.toggle('expanded');
});

var COMPONENTS = {
  "frontend": {
    name: "Frontend", name_zh: "ÂâçÁ´Ø", tooltip: "React + Tailwind UI layer", tooltip_zh: "React + Tailwind ÁïåÈù¢Â±Ç",
    desc: "The Frontend renders everything you see: quest cards, star counters, reward lists, calendar view. Built with React + Tailwind CSS, it uses next-intl for bilingual switching. Client Components handle interactive elements, Server Components pre-render pages for speed.",
    desc_zh: "ÂâçÁ´ØÊ∏≤Êüì‰Ω†ÁúãÂà∞ÁöÑ‰∏ÄÂàáÔºö‰ªªÂä°Âç°Áâá„ÄÅÊòüÊòüËÆ°Êï∞Âô®„ÄÅÂ•ñÂä±ÂàóË°®„ÄÅÊó•ÂéÜËßÜÂõæ„ÄÇÁî® React + Tailwind CSS ÊûÑÂª∫Ôºånext-intl ÂÆûÁé∞ÂèåËØ≠ÂàáÊç¢„ÄÇÂÆ¢Êà∑Á´ØÁªÑ‰ª∂Â§ÑÁêÜ‰∫§‰∫íÔºåÊúçÂä°Á´ØÁªÑ‰ª∂È¢ÑÊ∏≤ÊüìÊèêÈÄü„ÄÇ",
    tags: ["React", "Tailwind CSS", "next-intl", "TypeScript"],
    connections: [
      { target: "server", direction: "out", label: "HTTP requests", label_zh: "HTTP ËØ∑Ê±Ç" },
      { target: "analytics", direction: "out", label: "capture events", label_zh: "ÊçïËé∑‰∫ã‰ª∂" }
    ]
  },
  "server": {
    name: "Server", name_zh: "ÊúçÂä°Á´Ø", tooltip: "Next.js 15 server-side logic", tooltip_zh: "Next.js 15 ÊúçÂä°Á´ØÈÄªËæë",
    desc: "The brain of StarQuest. Pre-cooks pages with Server Components, runs API routes for star requests and redemptions, handles cron jobs for automated reports, manages email via Resend. Middleware checks auth and routes to correct locale on every request.",
    desc_zh: "StarQuest ÁöÑÂ§ßËÑë„ÄÇÁî®ÊúçÂä°Á´ØÁªÑ‰ª∂È¢ÑÊ∏≤ÊüìÈ°µÈù¢ÔºåËøêË°å API Ë∑ØÁî±Â§ÑÁêÜÊòüÊòüËØ∑Ê±ÇÂíåÂÖëÊç¢ÔºåÂ§ÑÁêÜÂÆöÊó∂‰ªªÂä°Ëá™Âä®Êä•ÂëäÔºåÈÄöËøá Resend ÁÆ°ÁêÜÈÇÆ‰ª∂„ÄÇ‰∏≠Èó¥‰ª∂ÊØèÊ¨°ËØ∑Ê±ÇÊ£ÄÊü•ËÆ§ËØÅÂπ∂Ë∑ØÁî±Âà∞Ê≠£Á°ÆËØ≠Ë®Ä„ÄÇ",
    tags: ["Next.js 15", "API Routes", "Cron", "Middleware"],
    connections: [
      { target: "database", direction: "out", label: "SQL via Supabase", label_zh: "Supabase SQL Êü•ËØ¢" },
      { target: "auth", direction: "out", label: "verify sessions", label_zh: "È™åËØÅ‰ºöËØù" },
      { target: "email", direction: "out", label: "send emails", label_zh: "ÂèëÈÄÅÈÇÆ‰ª∂" }
    ]
  },
  "database": {
    name: "Database", name_zh: "Êï∞ÊçÆÂ∫ì", tooltip: "Supabase + PostgreSQL with RLS", tooltip_zh: "Supabase + PostgreSQL Ë°åÁ∫ßÂÆâÂÖ®",
    desc: "Stores families, quests, star_transactions, rewards, redemptions, levels, credit data. Every table uses family_id with Row-Level Security ‚Äî each family only sees their own data. The child_balances VIEW auto-calculates star balances.",
    desc_zh: "Â≠òÂÇ®ÂÆ∂Â∫≠„ÄÅ‰ªªÂä°„ÄÅstar_transactions„ÄÅÂ•ñÂä±„ÄÅÂÖëÊç¢„ÄÅÁ≠âÁ∫ß„ÄÅ‰ø°Áî®Êï∞ÊçÆ„ÄÇÊØèÂº†Ë°®Áî® family_id ÈÖçÂêàË°åÁ∫ßÂÆâÂÖ® ‚Äî ÊØèÂÆ∂Âè™ÁúãËá™Â∑±ÁöÑÊï∞ÊçÆ„ÄÇchild_balances ËßÜÂõæËá™Âä®ËÆ°ÁÆóÊòüÊòü‰ΩôÈ¢ù„ÄÇ",
    tags: ["PostgreSQL", "Supabase", "RLS", "Views"],
    connections: [{ target: "server", direction: "in", label: "responds to queries", label_zh: "ÂìçÂ∫îÊü•ËØ¢" }]
  },
  "auth": {
    name: "Auth", name_zh: "ËÆ§ËØÅ", tooltip: "Authentication + Authorization", tooltip_zh: "ËÆ§ËØÅ + ÊéàÊùÉ",
    desc: "Supabase Auth handles login and magic links for demo mode. Next.js middleware runs intl first, then checks session. Parents go to /admin, children to /app. Critical: use window.location.href after login, NOT router.push!",
    desc_zh: "Supabase Auth Â§ÑÁêÜÁôªÂΩïÂíåÊºîÁ§∫Ê®°ÂºèÈ≠îÊ≥ïÈìæÊé•„ÄÇNext.js ‰∏≠Èó¥‰ª∂ÂÖàËøêË°åÂõΩÈôÖÂåñÔºåÂÜçÊ£ÄÊü•‰ºöËØù„ÄÇÂÆ∂ÈïøËøõ /adminÔºåÂ≠©Â≠êËøõ /app„ÄÇÂÖ≥ÈîÆÔºöÁôªÂΩïÂêéÁî® window.location.hrefÔºå‰∏çÊòØ router.pushÔºÅ",
    tags: ["Supabase Auth", "Magic Links", "RBAC"],
    connections: [{ target: "database", direction: "out", label: "user lookup", label_zh: "Áî®Êà∑Êü•ËØ¢" }]
  },
  "email": {
    name: "Email", name_zh: "ÈÇÆ‰ª∂", tooltip: "Transactional email via Resend", tooltip_zh: "ÈÄöËøá Resend ÂèëÈÄÅ‰∫ãÂä°ÈÇÆ‰ª∂",
    desc: "Sends parent invitations, weekly star summaries, monthly reports, and settlement notices. Templates are branded HTML with bilingual support. Daily cron triggers report generation automatically.",
    desc_zh: "ÂèëÈÄÅÂÆ∂ÈïøÈÇÄËØ∑„ÄÅÊØèÂë®ÊòüÊòüÊëòË¶Å„ÄÅÊúàÊä•ÂíåÁªìÁÆóÈÄöÁü•„ÄÇÊ®°ÊùøÊòØÂ∏¶ÂìÅÁâåÁöÑÂèåËØ≠ HTML„ÄÇÊØèÊó•ÂÆöÊó∂‰ªªÂä°Ëá™Âä®Ëß¶ÂèëÊä•ÂëäÁîüÊàê„ÄÇ",
    tags: ["Resend", "HTML Templates", "Cron"],
    connections: [{ target: "server", direction: "in", label: "triggered by API", label_zh: "Áî± API Ëß¶Âèë" }]
  },
  "analytics": {
    name: "Analytics", name_zh: "ÂàÜÊûê", tooltip: "PostHog product analytics", tooltip_zh: "PostHog ‰∫ßÂìÅÂàÜÊûê",
    desc: "PostHog tracks logins, star requests, redemptions. Privacy-first: children identified by UUID only, no session recordings for kids. Uses posthog-js (client) + posthog-node (server) with config split to prevent webpack errors.",
    desc_zh: "PostHog ËøΩË∏™ÁôªÂΩï„ÄÅÊòüÊòüËØ∑Ê±Ç„ÄÅÂÖëÊç¢„ÄÇÈöêÁßÅ‰ºòÂÖàÔºöÂÑøÁ´•‰ªÖÁî® UUID Ê†áËØÜÔºå‰∏çÂΩïÂà∂ÂÑøÁ´•‰ºöËØù„ÄÇ‰ΩøÁî® posthog-jsÔºàÂÆ¢Êà∑Á´ØÔºâ+ posthog-nodeÔºàÊúçÂä°Á´ØÔºâÔºåÈÖçÁΩÆÊãÜÂàÜÈò≤ webpack ÈîôËØØ„ÄÇ",
    tags: ["PostHog", "Privacy-First"],
    connections: [
      { target: "frontend", direction: "in", label: "client events", label_zh: "ÂÆ¢Êà∑Á´Ø‰∫ã‰ª∂" },
      { target: "server", direction: "in", label: "server events", label_zh: "ÊúçÂä°Á´Ø‰∫ã‰ª∂" }
    ]
  }
};

var currentNodeId = null;
function openPanel(data, nodeId) {
  var panel = document.getElementById('inline-detail');
  if (currentNodeId === nodeId) {
    closePanel();
    return;
  }
  currentNodeId = nodeId;
  document.getElementById('panel-title').textContent = currentLang === 'zh' ? (data.name_zh || data.name) : data.name;
  var tagsEl = document.getElementById('panel-tags');
  tagsEl.textContent = '';
  (data.tags || []).forEach(function(t) {
    var span = document.createElement('span');
    span.className = 'tag';
    span.textContent = t;
    tagsEl.appendChild(span);
  });
  var descEl = document.getElementById('panel-desc');
  descEl.textContent = currentLang === 'zh' ? (data.desc_zh || data.desc) : data.desc;
  var connEl = document.getElementById('panel-connections');
  connEl.textContent = '';
  if (data.connections && data.connections.length) {
    var h4 = document.createElement('h4');
    h4.textContent = currentLang === 'zh' ? 'ÂÖ≥ËÅî' : 'Connections';
    connEl.appendChild(h4);
    data.connections.forEach(function(c) {
      var div = document.createElement('div');
      div.className = 'conn-item';
      div.textContent = (c.direction === 'out' ? '‚Üí ' : '‚Üê ') + c.target + ': ' + (currentLang === 'zh' ? (c.label_zh || c.label) : c.label);
      connEl.appendChild(div);
    });
  }
  panel.classList.remove('open');
  void panel.offsetWidth;
  panel.classList.add('open');
  panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
function closePanel() {
  var panel = document.getElementById('inline-detail');
  panel.classList.remove('open');
  currentNodeId = null;
}

var tooltip = document.getElementById('tooltip');
function showTooltip(e, text) {
  tooltip.textContent = text;
  tooltip.style.left = e.clientX + 10 + 'px';
  tooltip.style.top = e.clientY + 10 + 'px';
  tooltip.classList.add('visible');
}
function hideTooltip() { tooltip.classList.remove('visible'); }

function filterComponents(query) {
  var q = query.toLowerCase();
  document.querySelectorAll('.node-group').forEach(function(node) {
    var name = (node.getAttribute('data-name') || '').toLowerCase();
    node.style.opacity = !q || name.includes(q) ? '1' : '0.2';
  });
}

/* ============================================================
   TAB 6: QUEST MATRIX DATA + RENDERING
   ============================================================ */
var QUEST_MATRIX_DATA = {
  bonus: {
    self:   { stars: '+15 ‚≠ê', range: '5‚Äì30',  color: 'bonus', desc_en: 'Self-improvement bonus: reading, exercise, study habits. Earn stars for building personal skills!', desc_zh: 'Ëá™ÊàëÊèêÂçáÂ•ñÂä±ÔºöÈòÖËØª„ÄÅÈîªÁÇº„ÄÅÂ≠¶‰π†‰π†ÊÉØ„ÄÇÂüπÂÖª‰∏™‰∫∫ÊäÄËÉΩËµöÊòüÊòüÔºÅ' },
    family: { stars: '+15 ‚≠ê', range: '10‚Äì25', color: 'bonus', desc_en: 'Family bonus: helping with dishes, cooking, cleaning. Stars for being a team player!', desc_zh: 'ÂÆ∂Â∫≠Â•ñÂä±ÔºöÂ∏ÆÂøôÊ¥óÁ¢ó„ÄÅÂÅöÈ•≠„ÄÅÊâìÊâ´„ÄÇÂÅöÂõ¢Èòü‰∏ÄÂëòËµöÊòüÊòüÔºÅ' },
    other:  { stars: '+20 ‚≠ê', range: '10‚Äì25', color: 'bonus', desc_en: 'Helping others: charity, sharing, kindness to friends. Extra stars for generosity!', desc_zh: 'Â∏ÆÂä©‰ªñ‰∫∫ÔºöÊÖàÂñÑ„ÄÅÂàÜ‰∫´„ÄÅÂØπÊúãÂèãÂèãÂñÑ„ÄÇÊÖ∑ÊÖ®Â§ßÊñπÈ¢ùÂ§ñÂæóÊòüÔºÅ' }
  },
  duty: {
    self:   { stars: '-10 ‚≠ê', range: '-5 to -15', color: 'duty', desc_en: 'Self duties: daily hygiene, homework, bedtime. Lose stars if duties are missed!', desc_zh: 'Ëá™Êàë‰πâÂä°ÔºöÊó•Â∏∏Âç´Áîü„ÄÅ‰Ωú‰∏ö„ÄÅÊåâÊó∂Áù°Ëßâ„ÄÇÊú™ÂÆåÊàêÊâ£ÊòüÔºÅ' },
    family: { stars: '-10 ‚≠ê', range: '-5 to -15', color: 'duty', desc_en: 'Family duties: assigned chores, pet care. Stars deducted when skipped.', desc_zh: 'ÂÆ∂Â∫≠‰πâÂä°ÔºöÂàÜÈÖçÁöÑÂÆ∂Âä°„ÄÅÁÖßÈ°æÂÆ†Áâ©„ÄÇË∑≥ËøáÊó∂Êâ£Êòü„ÄÇ' },
    other:  { stars: '-10 ‚≠ê', range: '-5 to -15', color: 'duty', desc_en: 'Social duties: being polite, following rules at school. Missing them costs stars.', desc_zh: 'Á§æ‰∫§‰πâÂä°ÔºöÁ§ºË≤åÂæÖ‰∫∫„ÄÅÈÅµÂÆàÂ≠¶Ê†°ËßÑÂàô„ÄÇÁº∫Â§±Êâ£Êòü„ÄÇ' }
  },
  violation: {
    self:   { stars: '-30 ‚≠ê', range: '-10 to -50', color: 'violation', desc_en: 'Self violations: tantrums, lying, breaking promises. Significant star penalty!', desc_zh: 'Ëá™ÊàëËøùËßÑÔºöÂèëËÑæÊ∞î„ÄÅËØ¥Ë∞é„ÄÅËøùÂèçÊâøËØ∫„ÄÇÂ§ßÈáèÊâ£ÊòüÔºÅ' },
    family: { stars: '-30 ‚≠ê', range: '-10 to -50', color: 'violation', desc_en: 'Family violations: fighting with siblings, disrespecting parents. Serious consequences.', desc_zh: 'ÂÆ∂Â∫≠ËøùËßÑÔºöÂíåÂÖÑÂºüÂßêÂ¶πÊâìÊû∂„ÄÅ‰∏çÂ∞äÈáçÁà∂ÊØç„ÄÇ‰∏•ÈáçÂêéÊûú„ÄÇ' },
    other:  { stars: '-30 ‚≠ê', range: '-10 to -50', color: 'violation', desc_en: 'Social violations: bullying, destructive behavior. Heaviest penalties.', desc_zh: 'Á§æ‰∫§ËøùËßÑÔºöÊ¨∫Âáå„ÄÅÁ†¥ÂùèË°å‰∏∫„ÄÇÊúÄÈáçÂ§ÑÁΩö„ÄÇ' }
  }
};

function renderQuestMatrix() {
  var container = document.getElementById('quest-matrix');
  if (!container) return;
  var types = ['bonus', 'duty', 'violation'];
  var scopes = ['self', 'family', 'other'];
  var typeLabelsEn = { bonus: 'Bonus', duty: 'Duty', violation: 'Violation' };
  var typeLabelsZh = { bonus: 'Â•ñÂä±', duty: '‰πâÂä°', violation: 'ËøùËßÑ' };
  var scopeLabelsEn = { self: 'Self', family: 'Family', other: 'Others' };
  var scopeLabelsZh = { self: 'Ëá™Êàë', family: 'ÂÆ∂Â∫≠', other: '‰ªñ‰∫∫' };

  // corner blank
  container.textContent = '';
  var blank = document.createElement('div');
  container.appendChild(blank);

  // column headers
  types.forEach(function(tp) {
    var h = document.createElement('div');
    h.className = 'matrix-header matrix-header-' + tp;
    h.setAttribute('data-en', typeLabelsEn[tp]);
    h.setAttribute('data-zh', typeLabelsZh[tp]);
    h.textContent = currentLang === 'zh' ? typeLabelsZh[tp] : typeLabelsEn[tp];
    container.appendChild(h);
  });

  // rows
  scopes.forEach(function(scope) {
    var label = document.createElement('div');
    label.className = 'matrix-row-label';
    label.setAttribute('data-en', scopeLabelsEn[scope]);
    label.setAttribute('data-zh', scopeLabelsZh[scope]);
    label.textContent = currentLang === 'zh' ? scopeLabelsZh[scope] : scopeLabelsEn[scope];
    container.appendChild(label);

    types.forEach(function(type) {
      var d = QUEST_MATRIX_DATA[type][scope];
      var cell = document.createElement('div');
      cell.className = 'matrix-cell matrix-cell-' + d.color;
      var starsDiv = document.createElement('div');
      starsDiv.className = 'matrix-stars';
      starsDiv.textContent = d.stars;
      var rangeDiv = document.createElement('div');
      rangeDiv.className = 'matrix-range';
      rangeDiv.textContent = d.range;
      cell.appendChild(starsDiv);
      cell.appendChild(rangeDiv);
      cell.addEventListener('click', function(e) {
        showMatrixTooltip(e, currentLang === 'zh' ? d.desc_zh : d.desc_en);
      });
      container.appendChild(cell);
    });
  });
}

function showMatrixTooltip(e, text) {
  var tip = document.getElementById('matrix-tooltip');
  if (!tip) return;
  tip.textContent = text;
  tip.classList.add('visible');
  var rect = e.target.getBoundingClientRect();
  var section = document.getElementById('tab-economy');
  var sRect = section.getBoundingClientRect();
  tip.style.left = (rect.left - sRect.left + rect.width / 2 - 110) + 'px';
  tip.style.top = (rect.bottom - sRect.top + 8) + 'px';
  setTimeout(function() { tip.classList.remove('visible'); }, 3000);
}

/* ============================================================
   TAB 7: DATABASE SCHEMA + DEMO
   ============================================================ */
var DB_TABLES = [
  { name: 'families', cols: [
    { label: 'id', type: 'pk' }, { label: 'name', type: '' }, { label: 'created_at', type: '' }
  ]},
  { name: 'users', cols: [
    { label: 'id', type: 'pk' }, { label: 'family_id', type: 'fk' },
    { label: 'name', type: '' }, { label: 'role', type: '' }, { label: 'email', type: '' }
  ]},
  { name: 'quests', cols: [
    { label: 'id', type: 'pk' }, { label: 'family_id', type: 'fk' },
    { label: 'name_en / zh', type: '' }, { label: 'type', type: '' },
    { label: 'scope', type: '' }, { label: 'stars', type: '' }
  ]},
  { name: 'star_transactions', cols: [
    { label: 'id', type: 'pk' }, { label: 'child_id', type: 'fk' },
    { label: 'quest_id', type: 'fk' }, { label: 'stars', type: '' },
    { label: 'status', type: '' }, { label: 'child_note', type: '' }
  ]},
  { name: 'rewards', cols: [
    { label: 'id', type: 'pk' }, { label: 'family_id', type: 'fk' },
    { label: 'name_en / zh', type: '' }, { label: 'stars_cost', type: '' }
  ]},
  { name: 'redemptions', cols: [
    { label: 'id', type: 'pk' }, { label: 'child_id', type: 'fk' },
    { label: 'reward_id', type: 'fk' }, { label: 'status', type: '' }
  ]},
  { name: 'levels', cols: [
    { label: 'id', type: 'pk' }, { label: 'family_id', type: 'fk' },
    { label: 'min_stars', type: '' }, { label: 'title_en', type: '' }
  ]},
  { name: 'child_balances', isView: true, cols: [
    { label: 'child_id', type: 'fk' }, { label: 'total_stars', type: '' },
    { label: 'spendable', type: '' }, { label: 'level_title', type: '' }
  ]}
];

function renderSchema() {
  var container = document.getElementById('schema-tables');
  if (!container) return;
  container.textContent = '';

  DB_TABLES.forEach(function(table) {
    var box = document.createElement('div');
    box.className = 'db-table' + (table.isView ? ' view-table' : '');

    var header = document.createElement('div');
    header.className = 'db-table-header';
    if (table.isView) {
      var viewLabel = currentLang === 'zh' ? 'ËßÜÂõæ' : 'VIEW';
      header.textContent = 'üëÅÔ∏è ' + table.name + ' ';
      var viewSpan = document.createElement('span');
      viewSpan.style.cssText = 'font-size:0.6rem;opacity:0.7';
      viewSpan.textContent = viewLabel;
      header.appendChild(viewSpan);
    } else {
      header.textContent = table.name;
    }
    box.appendChild(header);

    table.cols.forEach(function(col) {
      var row = document.createElement('div');
      row.className = 'db-table-row ' + col.type;
      var iconSpan = document.createElement('span');
      iconSpan.className = 'col-icon';
      iconSpan.textContent = col.type === 'pk' ? 'üîë' : col.type === 'fk' ? 'üîó' : '¬∑';
      row.appendChild(iconSpan);
      row.appendChild(document.createTextNode(col.label));
      box.appendChild(row);
    });

    container.appendChild(box);

    if (table.isView) {
      var note = document.createElement('div');
      note.style.cssText = 'font-size:0.82rem;color:var(--accent);text-align:center;margin-top:4px';
      note.textContent = currentLang === 'zh' ? '‚ú® Ëá™Âä®ËÆ°ÁÆóÔºÅ' : '‚ú® Computed!';
      note.setAttribute('data-en', '‚ú® Computed!');
      note.setAttribute('data-zh', '‚ú® Ëá™Âä®ËÆ°ÁÆóÔºÅ');
      container.appendChild(note);
    }
  });
}

var dbRowId = 1;
var dbDemoState = 'idle';
var currentBalance = 265;

function dbDemoInsert() {
  if (dbDemoState !== 'idle') return;
  dbDemoState = 'inserted';
  var rowsEl = document.getElementById('db-live-rows');
  var newRow = document.createElement('div');
  newRow.className = 'db-live-row';
  newRow.id = 'db-row-' + dbRowId;

  var idCol = document.createElement('div');
  idCol.className = 'id-col';
  idCol.textContent = '#' + String(dbRowId).padStart(3, '0');
  var descCol = document.createElement('div');
  descCol.className = 'desc-col';
  descCol.textContent = currentLang === 'zh' ? 'Â∏ÆÂøôÊ¥óÁ¢ó' : 'Help with Dishes';
  var starsCol = document.createElement('div');
  starsCol.className = 'stars-col';
  starsCol.textContent = '+15';
  var statusCol = document.createElement('div');
  var badge = document.createElement('span');
  badge.className = 'badge-pending';
  badge.textContent = currentLang === 'zh' ? 'ÂæÖÂÆ°Êâπ' : 'pending';
  statusCol.appendChild(badge);
  var childCol = document.createElement('div');
  childCol.style.color = '#a5b4fc';
  childCol.textContent = 'Alisa';

  newRow.appendChild(idCol);
  newRow.appendChild(descCol);
  newRow.appendChild(starsCol);
  newRow.appendChild(statusCol);
  newRow.appendChild(childCol);
  newRow.style.animation = 'rowInsert 0.6s ease forwards';
  rowsEl.appendChild(newRow);
  document.getElementById('btn-approve').disabled = false;
}

function dbDemoApprove() {
  if (dbDemoState !== 'inserted') return;
  dbDemoState = 'approved';
  var row = document.getElementById('db-row-' + dbRowId);
  if (!row) return;
  row.style.animation = 'goldFlash 0.8s ease 2';
  setTimeout(function() {
    var bdg = row.querySelector('.badge-pending');
    if (bdg) {
      bdg.className = 'badge-approved';
      bdg.textContent = currentLang === 'zh' ? 'Â∑≤ÊâπÂáÜ' : 'approved';
    }
  }, 800);
  var balanceEl = document.getElementById('db-balance-value');
  var newBalance = currentBalance + 15;
  animateCounter(balanceEl, currentBalance, newBalance, 1000);
  currentBalance = newBalance;
  document.getElementById('btn-approve').disabled = true;
  setTimeout(function() { dbRowId++; dbDemoState = 'idle'; }, 1500);
}

function animateCounter(el, from, to, duration) {
  var start = performance.now();
  function tick(now) {
    var elapsed = now - start;
    var progress = Math.min(elapsed / duration, 1);
    var eased = 1 - Math.pow(1 - progress, 3);
    var value = Math.round(from + (to - from) * eased);
    el.textContent = value;
    if (progress < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

(function() {
  var zh = /^zh/i.test(navigator.language);
  var a = document.getElementById('try-cta');
  if (a) {
    a.href = 'https://starquest.beluga-tempo.com/' + (zh ? 'zh-CN' : 'en');
    a.textContent = zh ? 'Áé∞Âú®Â∞±ËØïËØïÂêß' : 'Try it now!';
  }
})();

document.addEventListener('DOMContentLoaded', function() {
  createStars();
  renderQuestMatrix();
  renderSchema();
  document.querySelectorAll('.node-group').forEach(function(node) {
    var id = node.getAttribute('data-id');
    if (id && COMPONENTS[id]) {
      node.addEventListener('click', function() { openPanel(COMPONENTS[id], id); });
      node.addEventListener('mouseenter', function(e) {
        showTooltip(e, currentLang === 'zh' ? (COMPONENTS[id].tooltip_zh || COMPONENTS[id].name) : (COMPONENTS[id].tooltip || COMPONENTS[id].name));
      });
      node.addEventListener('mouseleave', hideTooltip);
    }
  });
  document.querySelectorAll('.flow-path').forEach(function(path) {
    var particle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    particle.classList.add('flow-particle');
    particle.setAttribute('r', '3');
    particle.setAttribute('fill', path.getAttribute('stroke') || '#00d4ff');
    var anim = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
    anim.setAttribute('dur', (2 + Math.random() * 2) + 's');
    anim.setAttribute('repeatCount', 'indefinite');
    var mpath = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
    mpath.setAttributeNS('http://www.w3.org/1999/xlink', 'href', '#' + path.id);
    anim.appendChild(mpath);
    particle.appendChild(anim);
    path.parentNode.appendChild(particle);
  });
});
</script>
</body>
</html>
