# å¤šå®¶é•¿åŠŸèƒ½è®¾ç½®æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

ç°åœ¨ StarQuest æ”¯æŒå¤šå®¶é•¿åŠŸèƒ½ï¼ä¸€ä¸ªå®¶åº­å¯ä»¥æœ‰å¤šä¸ªå®¶é•¿ï¼ˆçˆ¸çˆ¸ã€å¦ˆå¦ˆç­‰ï¼‰ï¼Œä»–ä»¬éƒ½èƒ½ï¼š
- ç®¡ç†å­©å­çš„ä»»åŠ¡å’Œå¥–åŠ±
- å®¡æ‰¹å­©å­çš„è¯·æ±‚
- æŸ¥çœ‹å®¶åº­æ•°æ®

## ğŸ› ï¸ å®‰è£…æ­¥éª¤

### 1. åº”ç”¨æ•°æ®åº“ Migrations

ä½ éœ€è¦åœ¨ Supabase ä¸­è¿è¡Œä»¥ä¸‹ 3 ä¸ª migration æ–‡ä»¶ï¼š

#### Migration 1: ä¿®å¤ Email çº¦æŸå’ŒåŸºç¡€å¤šå®¶é•¿æ”¯æŒ
æ–‡ä»¶ï¼š`supabase/migrations/20250103000000_fix_email_and_multi_parent.sql`

**åœ¨ Supabase Dashboard ä¸­ï¼š**
1. æ‰“å¼€ä½ çš„é¡¹ç›®
2. å·¦ä¾§èœå• â†’ SQL Editor
3. ç‚¹å‡» "New query"
4. å¤åˆ¶ç²˜è´´ `20250103000000_fix_email_and_multi_parent.sql` çš„å…¨éƒ¨å†…å®¹
5. ç‚¹å‡» "Run" æ‰§è¡Œ

è¿™ä¸ª migration ä¼šï¼š
- âœ… æ”¹è¿› `create_family_with_templates` å‡½æ•°ï¼ˆæ›´å¥½åœ°å¤„ç†é‡å¤ emailï¼‰
- âœ… æ·»åŠ  `add_parent_to_family` å‡½æ•°ï¼ˆå…è®¸æ·»åŠ ç¬¬äºŒå®¶é•¿ï¼‰

#### Migration 2: æ·»åŠ é‚€è¯·ç ç³»ç»Ÿ
æ–‡ä»¶ï¼š`supabase/migrations/20250103000001_add_family_invites.sql`

**æ‰§è¡Œæ­¥éª¤åŒä¸Šï¼Œå†…å®¹æ›¿æ¢ä¸ºè¿™ä¸ªæ–‡ä»¶ã€‚**

è¿™ä¸ª migration ä¼šï¼š
- âœ… åˆ›å»º `family_invites` è¡¨ï¼ˆå­˜å‚¨é‚€è¯·ç ï¼‰
- âœ… æ·»åŠ é‚€è¯·ç ç”Ÿæˆå‡½æ•° `create_family_invite`
- âœ… æ·»åŠ é‚€è¯·ç éªŒè¯å‡½æ•° `validate_invite_code`
- âœ… æ·»åŠ åŠ å…¥å®¶åº­å‡½æ•° `join_family_with_invite`
- âœ… è®¾ç½® RLS æƒé™

### 2. æ¸…ç†ç°æœ‰çš„å­¤å„¿è´¦æˆ·

å¦‚æœä¹‹å‰æµ‹è¯•æ—¶ç•™ä¸‹äº†å­¤å„¿è´¦æˆ·ï¼ˆå¦‚ `flyrhyme@gmail.com`ï¼‰ï¼Œéœ€è¦æ¸…ç†ï¼š

```sql
-- åœ¨ Supabase SQL Editor ä¸­è¿è¡Œï¼š

-- 1. æ£€æŸ¥æ˜¯å¦æœ‰å­¤å„¿è´¦æˆ·
SELECT
  au.email,
  au.id as auth_id,
  u.id as user_id,
  u.family_id
FROM auth.users au
LEFT JOIN users u ON u.id = au.id
WHERE au.email = 'flyrhyme@gmail.com';

-- 2. å¦‚æœ family_id æ˜¯ NULLï¼Œåˆ é™¤è®°å½•
DELETE FROM users WHERE email = 'flyrhyme@gmail.com';
DELETE FROM auth.users WHERE email = 'flyrhyme@gmail.com';
```

### 3. éªŒè¯å®‰è£…

è¿è¡Œä»¥ä¸‹æŸ¥è¯¢ç¡®è®¤æ‰€æœ‰å‡½æ•°éƒ½å·²åˆ›å»ºï¼š

```sql
-- æ£€æŸ¥å‡½æ•°æ˜¯å¦å­˜åœ¨
SELECT routine_name
FROM information_schema.routines
WHERE routine_schema = 'public'
  AND routine_name IN (
    'create_family_with_templates',
    'add_parent_to_family',
    'create_family_invite',
    'validate_invite_code',
    'join_family_with_invite',
    'generate_invite_code'
  );

-- åº”è¯¥è¿”å› 6 è¡Œ
```

## ğŸ¯ åŠŸèƒ½ä½¿ç”¨æµç¨‹

### æ–¹æ¡ˆ 1ï¼šåˆ›å»ºæ–°å®¶åº­ï¼ˆç¬¬ä¸€å®¶é•¿ï¼‰

1. è®¿é—® `http://localhost:3003/en/register` æˆ– `http://localhost:3003/zh-CN/register`
2. **ä¸å¡«å†™**é‚€è¯·ç å­—æ®µ
3. å¡«å†™ï¼š
   - é‚®ç®±
   - å¯†ç 
   - ç¡®è®¤å¯†ç 
   - **å®¶åº­åç§°**ï¼ˆä¾‹å¦‚ï¼š"Kong Family"ï¼‰
   - æ‚¨çš„åå­—ï¼ˆå®¶é•¿ï¼‰
4. ç‚¹å‡»"æ³¨å†Œ"
5. ç³»ç»Ÿä¼šï¼š
   - åˆ›å»ºè®¤è¯è´¦æˆ·
   - åˆ›å»ºå®¶åº­
   - æ·»åŠ ä½ ä¸ºç¬¬ä¸€å®¶é•¿
   - åˆå§‹åŒ–é»˜è®¤ä»»åŠ¡ã€å¥–åŠ±ã€ç­‰çº§
   - é‡å®šå‘åˆ° `/admin` é¡µé¢

### æ–¹æ¡ˆ 2ï¼šåŠ å…¥ç°æœ‰å®¶åº­ï¼ˆç¬¬äºŒå®¶é•¿ï¼‰

#### æ­¥éª¤ Aï¼šç¬¬ä¸€å®¶é•¿ç”Ÿæˆé‚€è¯·ç 

1. ç¬¬ä¸€å®¶é•¿ç™»å½• â†’ è®¿é—® `/admin` é¡µé¢
2. åœ¨å³ä¸Šè§’çœ‹åˆ°æ–°çš„"é‚€è¯·å®¶é•¿"å¡ç‰‡
3. ç‚¹å‡»"ç”Ÿæˆé‚€è¯·ç "
4. ç³»ç»Ÿç”Ÿæˆ 8 ä½é‚€è¯·ç ï¼ˆä¾‹å¦‚ï¼š`ABC12XYZ`ï¼‰
5. ç‚¹å‡»"å¤åˆ¶"æŒ‰é’®ï¼Œä¼šå¤åˆ¶é‚€è¯·é“¾æ¥å’Œè¯´æ˜
6. åˆ†äº«ç»™ç¬¬äºŒå®¶é•¿

#### æ­¥éª¤ Bï¼šç¬¬äºŒå®¶é•¿ä½¿ç”¨é‚€è¯·ç æ³¨å†Œ

**æ–¹æ³• 1ï¼šé€šè¿‡é“¾æ¥**
1. ç¬¬ä¸€å®¶é•¿åˆ†äº«é“¾æ¥ï¼š`http://localhost:3003/en/register?invite=ABC12XYZ`
2. ç¬¬äºŒå®¶é•¿ç‚¹å‡»é“¾æ¥
3. é‚€è¯·ç ä¼šè‡ªåŠ¨å¡«å……
4. é¡µé¢æ˜¾ç¤ºç»¿è‰²æç¤ºï¼š"âœ“ å°†åŠ å…¥å®¶åº­ï¼šKong Family"
5. æ³¨æ„ï¼š**å®¶åº­åç§°å­—æ®µä¼šéšè—**ï¼ˆå› ä¸ºåŠ å…¥ç°æœ‰å®¶åº­ï¼‰
6. å¡«å†™ï¼š
   - é‚®ç®±ï¼ˆå¿…é¡»ä¸åŒäºç¬¬ä¸€å®¶é•¿ï¼‰
   - å¯†ç 
   - ç¡®è®¤å¯†ç 
   - æ‚¨çš„åå­—ï¼ˆå®¶é•¿ï¼‰
7. ç‚¹å‡»"æ³¨å†Œ"
8. æˆåŠŸåé‡å®šå‘åˆ° `/admin`ï¼Œå¯ä»¥çœ‹åˆ°ç›¸åŒçš„å®¶åº­æ•°æ®

**æ–¹æ³• 2ï¼šæ‰‹åŠ¨è¾“å…¥é‚€è¯·ç **
1. è®¿é—® `http://localhost:3003/en/register`
2. åœ¨"é‚€è¯·ç ï¼ˆå¯é€‰ï¼‰"å­—æ®µè¾“å…¥ï¼š`ABC12XYZ`
3. ç³»ç»Ÿè‡ªåŠ¨éªŒè¯ï¼Œæ˜¾ç¤ºï¼š"âœ“ å°†åŠ å…¥å®¶åº­ï¼šKong Family"
4. åç»­æ­¥éª¤åŒä¸Š

## ğŸ” æƒé™å’Œé™åˆ¶

### å¤šå®¶é•¿æƒé™
- âœ… æ‰€æœ‰å®¶é•¿æ‹¥æœ‰**å®Œå…¨ç›¸åŒ**çš„æƒé™
- âœ… éƒ½å¯ä»¥ç®¡ç†å­©å­ã€ä»»åŠ¡ã€å¥–åŠ±
- âœ… éƒ½å¯ä»¥ç”Ÿæˆæ–°çš„é‚€è¯·ç ï¼ˆé‚€è¯·ç¬¬ä¸‰ã€ç¬¬å››å®¶é•¿ï¼‰
- âœ… éƒ½å¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹å®¶åº­æ•°æ®

### é‚€è¯·ç è§„åˆ™
- ğŸ“… æœ‰æ•ˆæœŸï¼š**7 å¤©**
- ğŸ”„ ä¸€æ¬¡æ€§ä½¿ç”¨ï¼šä½¿ç”¨åè‡ªåŠ¨å¤±æ•ˆ
- ğŸ†• å¯ä»¥ç”Ÿæˆå¤šä¸ªé‚€è¯·ç ï¼ˆæ¯ä¸ªå®¶é•¿éƒ½èƒ½ç”Ÿæˆï¼‰
- ğŸ”’ æ¯ä¸ªé‚€è¯·ç å¯¹åº”ä¸€ä¸ªç‰¹å®šå®¶åº­

### Email å”¯ä¸€æ€§
- âš ï¸ æ¯ä¸ªå®¶é•¿å¿…é¡»æœ‰**ä¸åŒçš„ email**
- âš ï¸ åŒä¸€ä¸ª email ä¸èƒ½æ³¨å†Œä¸¤æ¬¡
- âœ… è¿™æ˜¯ Supabase Auth çš„è¦æ±‚ï¼Œç¬¦åˆå®é™…ä½¿ç”¨åœºæ™¯

## ğŸ“Š æ•°æ®åº“ç»“æ„

### family_invites è¡¨
```sql
CREATE TABLE family_invites (
  id UUID PRIMARY KEY,
  family_id UUID,                  -- å…³è”çš„å®¶åº­
  invite_code TEXT UNIQUE,         -- 8ä½é‚€è¯·ç 
  created_by UUID,                 -- ç”Ÿæˆé‚€è¯·ç çš„å®¶é•¿
  status TEXT,                     -- 'active' | 'used' | 'expired'
  used_by UUID,                    -- ä½¿ç”¨é‚€è¯·ç çš„ç”¨æˆ·
  expires_at TIMESTAMP,            -- è¿‡æœŸæ—¶é—´ï¼ˆ7å¤©åï¼‰
  created_at TIMESTAMP,
  used_at TIMESTAMP
);
```

### users è¡¨ï¼ˆæ— æ”¹åŠ¨ï¼‰
```sql
-- å·²ç»æ”¯æŒå¤šå®¶é•¿ï¼
CREATE TABLE users (
  id UUID PRIMARY KEY,
  family_id UUID,
  name TEXT,
  role TEXT,  -- 'parent' | 'child'
  email TEXT UNIQUE,
  ...
);
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯• 1ï¼šåˆ›å»ºæ–°å®¶åº­
1. æ³¨å†Œç”¨æˆ· Aï¼ˆ`parent1@example.com`ï¼‰
2. åˆ›å»ºå®¶åº­"Test Family"
3. éªŒè¯ï¼šå¯ä»¥è®¿é—® `/admin`ï¼Œçœ‹åˆ°å®¶åº­æ•°æ®

### æµ‹è¯• 2ï¼šé‚€è¯·ç¬¬äºŒå®¶é•¿
1. ç”¨æˆ· A åœ¨ `/admin` ç”Ÿæˆé‚€è¯·ç ï¼ˆå¦‚ `TEST1234`ï¼‰
2. éªŒè¯ï¼šé‚€è¯·ç æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š

### æµ‹è¯• 3ï¼šç¬¬äºŒå®¶é•¿åŠ å…¥
1. é€€å‡ºç™»å½•ï¼ˆæˆ–ä½¿ç”¨éšèº«çª—å£ï¼‰
2. è®¿é—® `/register?invite=TEST1234`
3. æ³¨å†Œç”¨æˆ· Bï¼ˆ`parent2@example.com`ï¼‰
4. éªŒè¯ï¼š
   - é¡µé¢æ˜¾ç¤º"å°†åŠ å…¥å®¶åº­ï¼šTest Family"
   - å®¶åº­åç§°å­—æ®µéšè—
   - æ³¨å†ŒæˆåŠŸåï¼Œç”¨æˆ· B ä¹Ÿèƒ½è®¿é—® `/admin`
   - ç”¨æˆ· B çœ‹åˆ°çš„å®¶åº­æ•°æ®ä¸ç”¨æˆ· A ç›¸åŒ

### æµ‹è¯• 4ï¼šå¤šå®¶é•¿æƒé™
1. ç”¨æˆ· A æ·»åŠ ä¸€ä¸ªå­©å­
2. ç”¨æˆ· B ç™»å½•ï¼Œåº”è¯¥èƒ½çœ‹åˆ°è¿™ä¸ªå­©å­
3. ç”¨æˆ· B è®°å½•æ˜Ÿæ˜Ÿï¼Œç”¨æˆ· A åº”è¯¥èƒ½çœ‹åˆ°
4. éªŒè¯ï¼šä¸¤ä¸ªå®¶é•¿æ•°æ®å®Œå…¨åŒæ­¥

### æµ‹è¯• 5ï¼šé‚€è¯·ç è¿‡æœŸ
1. åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨ä¿®æ”¹é‚€è¯·ç çš„ `expires_at` ä¸ºè¿‡å»çš„æ—¶é—´
2. å°è¯•ä½¿ç”¨è¯¥é‚€è¯·ç æ³¨å†Œ
3. éªŒè¯ï¼šæ˜¾ç¤º"é‚€è¯·ç æ— æ•ˆæˆ–å·²è¿‡æœŸ"

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šé‚€è¯·ç éªŒè¯å¤±è´¥
**ç—‡çŠ¶ï¼š** è¾“å…¥é‚€è¯·ç åæ˜¾ç¤º"éªŒè¯é‚€è¯·ç å¤±è´¥"

**è§£å†³ï¼š**
```sql
-- æ£€æŸ¥é‚€è¯·ç æ˜¯å¦å­˜åœ¨
SELECT * FROM family_invites WHERE invite_code = 'YOUR_CODE';

-- æ£€æŸ¥å‡½æ•°æƒé™
GRANT EXECUTE ON FUNCTION validate_invite_code(TEXT) TO anon;
GRANT EXECUTE ON FUNCTION validate_invite_code(TEXT) TO authenticated;
```

### é—®é¢˜ 2ï¼šæ³¨å†Œæ—¶ Email é‡å¤é”™è¯¯
**ç—‡çŠ¶ï¼š** `duplicate key value violates unique constraint "users_email_key"`

**è§£å†³ï¼š**
```sql
-- åˆ é™¤æ—§çš„å­¤å„¿è®°å½•
DELETE FROM users WHERE email = 'your@email.com' AND family_id IS NULL;
DELETE FROM auth.users WHERE email = 'your@email.com';
```

### é—®é¢˜ 3ï¼šåŠ å…¥å®¶åº­åçœ‹ä¸åˆ°æ•°æ®
**ç—‡çŠ¶ï¼š** ç¬¬äºŒå®¶é•¿ç™»å½•åï¼Œadmin é¡µé¢æ˜¾ç¤ºç©ºç™½

**è§£å†³ï¼š**
```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ­£ç¡®åŠ å…¥å®¶åº­
SELECT u.name, u.email, u.family_id, f.name as family_name
FROM users u
JOIN families f ON f.id = u.family_id
WHERE u.email = 'parent2@example.com';

-- å¦‚æœ family_id æ˜¯ NULLï¼Œæ‰‹åŠ¨ä¿®å¤
UPDATE users
SET family_id = 'FAMILY_ID_FROM_PARENT1'
WHERE email = 'parent2@example.com';
```

### é—®é¢˜ 4ï¼šæ— æ³•ç”Ÿæˆé‚€è¯·ç 
**ç—‡çŠ¶ï¼š** ç‚¹å‡»"ç”Ÿæˆé‚€è¯·ç "æŒ‰é’®åæŠ¥é”™

**æ£€æŸ¥ Console é”™è¯¯ï¼š**
```javascript
// å¯èƒ½çš„åŸå› ï¼š
// 1. å‡½æ•°ä¸å­˜åœ¨
// 2. æƒé™ä¸è¶³
// 3. family_id æ— æ•ˆ

// åœ¨ SQL Editor éªŒè¯ï¼š
SELECT create_family_invite('YOUR_FAMILY_ID');
```

## ğŸ“ ä»£ç æ”¹åŠ¨æ€»ç»“

### æ–°å¢æ–‡ä»¶
1. `supabase/migrations/20250103000000_fix_email_and_multi_parent.sql`
2. `supabase/migrations/20250103000001_add_family_invites.sql`
3. `components/admin/InviteParentCard.tsx`
4. `MULTI_PARENT_SETUP.md`ï¼ˆæœ¬æ–‡ä»¶ï¼‰

### ä¿®æ”¹æ–‡ä»¶
1. `components/auth/RegisterForm.tsx`
   - æ·»åŠ é‚€è¯·ç å­—æ®µ
   - æ·»åŠ é‚€è¯·ç éªŒè¯é€»è¾‘
   - æ”¯æŒä¸¤ç§æ³¨å†Œæµç¨‹ï¼ˆåˆ›å»ºå®¶åº­ vs åŠ å…¥å®¶åº­ï¼‰
   - æ”¯æŒ URL å‚æ•° `?invite=CODE`

2. `app/[locale]/(parent)/admin/page.tsx`
   - æ·»åŠ  InviteParentCard ç»„ä»¶
   - å°†ç½‘æ ¼ä» 3 åˆ—æ”¹ä¸º 4 åˆ—

## ğŸ‰ ä¸‹ä¸€æ­¥

æ•°æ®åº“ migrations åº”ç”¨åï¼ŒåŠŸèƒ½å°±å¯ä»¥ä½¿ç”¨äº†ï¼

**ç«‹å³æµ‹è¯•ï¼š**
1. æ¸…ç†æ—§çš„å­¤å„¿è´¦æˆ·ï¼ˆå¦‚æœæœ‰ï¼‰
2. åˆ›å»ºä¸€ä¸ªæ–°å®¶åº­
3. ç”Ÿæˆé‚€è¯·ç 
4. ç”¨å¦ä¸€ä¸ª email åŠ å…¥å®¶åº­
5. éªŒè¯ä¸¤ä¸ªå®¶é•¿éƒ½èƒ½ç®¡ç†ç›¸åŒçš„æ•°æ®

**ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹ï¼š**
- âš ï¸ é‚€è¯·ç é€šè¿‡éåŠ å¯†æ–¹å¼åˆ†äº«ï¼ˆçŸ­ä¿¡ã€å¾®ä¿¡ç­‰ï¼‰
- âš ï¸ è€ƒè™‘æ·»åŠ é‚®ä»¶é‚€è¯·åŠŸèƒ½ï¼ˆæ›´å®‰å…¨ï¼‰
- âš ï¸ è€ƒè™‘é™åˆ¶æ¯ä¸ªå®¶åº­çš„å®¶é•¿æ•°é‡ï¼ˆä¾‹å¦‚æœ€å¤š 2-3 ä¸ªï¼‰
- âš ï¸ æ·»åŠ "æ’¤é”€é‚€è¯·ç "åŠŸèƒ½
- âš ï¸ æ·»åŠ "ç§»é™¤å®¶é•¿"åŠŸèƒ½ï¼ˆéœ€è°¨æ…è®¾è®¡æƒé™ï¼‰
