# PRD æ›´æ–°å®žæ–½æ€»ç»“ | PRD Update Implementation Summary

> æœ¬æ–‡æ¡£è®°å½•äº†å¯¹ StarQuest ä»»åŠ¡åˆ†ç±»ç³»ç»Ÿçš„é‡å¤§æ›´æ–°å®žæ–½è¿‡ç¨‹

---

## ðŸ“‹ æ›´æ–°æ¦‚è§ˆ | Update Overview

**æ›´æ–°æ—¥æœŸ**: 2025-01-02
**æ›´æ–°èŒƒå›´**: ä»»åŠ¡åˆ†ç±»ç³»ç»Ÿé‡æž„
**å½±å“èŒƒå›´**: æ•°æ®åº“schemaã€ç±»åž‹å®šä¹‰ã€å­©å­ç«¯UIã€å®¶é•¿ç«¯UI

---

## ðŸŽ¯ æ ¸å¿ƒå˜æ›´ | Core Changes

### 1. æ•°æ®åº“ Schema å˜æ›´

#### æ–°å¢žå­—æ®µ (New Fields)

åœ¨ `quests` è¡¨ä¸­æ·»åŠ äº†ä¸‰ä¸ªæ–°å­—æ®µ:

| å­—æ®µ | ç±»åž‹ | è¯´æ˜Ž | çº¦æŸ |
|------|------|------|------|
| `type` | TEXT | ä»»åŠ¡ç±»åž‹ | duty, bonus, violation |
| `scope` | TEXT | ä»»åŠ¡å½’å±ž | self, family, other |
| `max_per_day` | INTEGER | æ¯æ—¥æœ€å¤§è®°å½•æ¬¡æ•° | é»˜è®¤ 1 |

#### è¿ç§»æ–‡ä»¶

- **æ–‡ä»¶**: `supabase/migrations/20250102000000_add_quest_type_scope.sql`
- **æ“ä½œ**:
  - æ·»åŠ æ–°å­—æ®µåŠçº¦æŸ
  - åˆ›å»ºç´¢å¼• (idx_quests_type, idx_quests_scope)
  - è¿ç§»çŽ°æœ‰æ•°æ® (æ ¹æ® stars æ­£è´Ÿå€¼è®¾ç½® type)

### 2. ä»»åŠ¡æ¨¡æ¿æ›´æ–°

#### æ–° Seed Data

- **æ–‡ä»¶**: `supabase/migrations/20250102000001_update_seed_templates.sql`
- **å˜æ›´**: å®Œå…¨é‡å†™ `initialize_family_templates()` å‡½æ•°
- **æ–°æ¨¡æ¿æ•°é‡**:
  - My Duties (æ—¥å¸¸æœ¬åˆ†): 11 ä¸ªä»»åŠ¡
  - Helping Family (å¸®åŠ©å®¶äºº): 7 ä¸ªä»»åŠ¡
  - Self Bonus (è‡ªæˆ‘æå‡): 6 ä¸ªä»»åŠ¡
  - Helping Others (å¸®åŠ©ä»–äºº): 5 ä¸ªä»»åŠ¡
  - Violations (è¿è§„è¡Œä¸º): 7 ä¸ªä»»åŠ¡
  - Rewards: 11 ä¸ªå¥–åŠ±

---

## ðŸ”„ ä»»åŠ¡åˆ†ç±»ç³»ç»Ÿ | Quest Classification System

### Type (ä»»åŠ¡ç±»åž‹)

| Type | è‹±æ–‡ | ä¸­æ–‡ | æ˜Ÿæ˜Ÿé€»è¾‘ | è®°å½•æ–¹å¼ |
|------|------|------|----------|----------|
| `duty` | Daily Duties | æ—¥å¸¸æœ¬åˆ† | æ²¡åš = æ‰£åˆ† | å®¶é•¿è®°å½• |
| `bonus` | Bonus Quests | åŠ åˆ†ä»»åŠ¡ | åšäº† = åŠ åˆ† | å­©å­ç”³è¯· |
| `violation` | Violations | è¿è§„è¡Œä¸º | å‘ç”Ÿ = æ‰£åˆ† | å®¶é•¿è®°å½• |

### Scope (ä»»åŠ¡å½’å±ž)

| Scope | è‹±æ–‡ | ä¸­æ–‡ | é€‚ç”¨äºŽ |
|-------|------|------|--------|
| `self` | Self | è‡ªå·± | æ—¥å¸¸æœ¬åˆ† / è‡ªæˆ‘æå‡ |
| `family` | Family | å®¶äºº | å¸®åŠ©å®¶äºº |
| `other` | Others | ä»–äºº | å¸®åŠ©ä»–äºº |

### Category (ä»»åŠ¡ç±»åˆ«)

æ›´æ–°äº†ç±»åˆ«åˆ—è¡¨:

| Category | è‹±æ–‡ | ä¸­æ–‡ | å›¾æ ‡ |
|----------|------|------|------|
| `hygiene` | Hygiene | å«ç”Ÿ | ðŸ§¼ *(æ–°å¢ž)* |
| `chores` | Chores | å®¶åŠ¡ | ðŸ§¹ |
| `learning` | Learning | å­¦ä¹  | ðŸ“š |
| `health` | Health | å¥åº· | ðŸ’ª |
| `social` | Social | ç¤¾äº¤ | ðŸ¤ *(æ–°å¢ž)* |
| `other` | Other | å…¶ä»– | ðŸ“¦ |

**ç§»é™¤**: `manners` (ç¤¼ä»ª) â†’ åˆå¹¶åˆ° `social`

---

## ðŸ’» ä»£ç å˜æ›´ | Code Changes

### 1. TypeScript ç±»åž‹å®šä¹‰

#### æ–‡ä»¶: `types/database.ts`
- æ›´æ–° `quests` è¡¨çš„ Row/Insert/Update ç±»åž‹
- æ·»åŠ  `type`, `scope`, `max_per_day` å­—æ®µ
- æ›´æ–° `category` æžšä¸¾å€¼

#### æ–°æ–‡ä»¶: `types/quest.ts`
- Quest ç›¸å…³ç±»åž‹å®šä¹‰å’Œå·¥å…·å‡½æ•°
- `groupQuests()` - æŒ‰ type+scope åˆ†ç»„
- `getChildVisibleQuests()` - ç­›é€‰å­©å­å¯è§çš„ä»»åŠ¡ (ä»… bonus)
- `getSuggestedStars()` - èŽ·å–å»ºè®®æ˜Ÿæ˜Ÿå€¼
- `categoryLabels`, `typeLabels`, `scopeLabels` - æ ‡ç­¾å®šä¹‰

### 2. å­©å­ç«¯æ›´æ–°

#### `app/[locale]/(child)/app/quests/page.tsx`
**å˜æ›´**:
- æŸ¥è¯¢æ¡ä»¶ä»Ž `is_positive = true` æ”¹ä¸º `type = 'bonus'`
- æŒ‰ scope æŽ’åº
- æ›´æ–°é¡µé¢æè¿°å’Œæç¤ºä¿¡æ¯

#### `components/child/QuestGrid.tsx`
**é‡å¤§é‡æž„**:
- ç§»é™¤ç±»åˆ«ç­›é€‰ï¼Œæ”¹ä¸ºæŒ‰ scope åˆ†ç»„å±•ç¤º
- ä¸‰ä¸ªç‹¬ç«‹çš„åŒºå—:
  1. ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Helping Family (å¸®åŠ©å®¶äºº)
  2. ðŸ‘¤ Self Improvement (è‡ªæˆ‘æå‡)
  3. ðŸŒ Helping Others (å¸®åŠ©ä»–äºº)
- æ›´æ–°é¢œè‰²æ˜ å°„ï¼Œæ·»åŠ  `hygiene` å’Œ `social` ç±»åˆ«

### 3. å®¶é•¿ç«¯æ›´æ–°

#### `components/admin/QuickRecordForm.tsx`
**é‡å¤§é‡æž„**:
- ä»»åŠ¡åˆ†ç»„ä»Ž positive/negative æ”¹ä¸º type-based:
  1. â­ Did Good / åšäº†å¥½äº‹ (Bonus)
  2. ðŸ“‹ Missed Duty / æ¼åšæœ¬åˆ† (Duty)
  3. âš ï¸ Violation / è¿è§„äº† (Violation)
- ä¸åŒç±»åž‹ä½¿ç”¨ä¸åŒçš„è§†è§‰æ ·å¼å’Œé¢œè‰²

### 4. å›½é™…åŒ–æ›´æ–°

#### `messages/en.json` å’Œ `messages/zh-CN.json`
**æ›´æ–° quests.category**:
```json
{
  "learning": "Learning / å­¦ä¹ ",
  "chores": "Chores / å®¶åŠ¡",
  "hygiene": "Hygiene / å«ç”Ÿ", // æ–°å¢ž
  "health": "Health / å¥åº·",
  "social": "Social / ç¤¾äº¤", // æ–°å¢ž
  "other": "Other / å…¶ä»–"
}
```

---

## ðŸ”‘ æ ¸å¿ƒè®¾è®¡åŽŸåˆ™ | Core Design Principles

### 1. æ­£å‘ä¸ºä¸» (Positive Focus)
- å­©å­ç«¯**åªæ˜¾ç¤º** Bonus Quests
- å¼ºåŒ–"åšå¥½äº‹èŽ·å¾—å¥–åŠ±"çš„æ­£å‘ä½“éªŒ
- Duties å’Œ Violations ç”±å®¶é•¿è®°å½•ï¼Œä¸è®©å­©å­çœ‹åˆ°è´Ÿé¢ä»»åŠ¡åˆ—è¡¨

### 2. è´£ä»»å…ˆè¡Œ (Responsibility First)
- Duties (æ—¥å¸¸æœ¬åˆ†): åº”è¯¥åšçš„äº‹ï¼Œæ²¡åšæ‰æ‰£åˆ†
- é»˜è®¤æœŸæœ›å­©å­å®Œæˆæœ¬åˆ†ï¼Œä¸éœ€è¦å¥–åŠ±

### 3. é¼“åŠ±è¶…è¶Š (Encourage Excellence)
- Bonus Quests: é¢å¤–çš„å¥½è¡¨çŽ°æ‰èƒ½èŽ·å¾—æ˜Ÿæ˜Ÿ
- ä¸‰ä¸ªæ–¹å‘: å¸®åŠ©å®¶äººã€è‡ªæˆ‘æå‡ã€å¸®åŠ©ä»–äºº
- åŸ¹å…»å­©å­çš„ä¸»åŠ¨æ€§å’Œç¤¾ä¼šè´£ä»»æ„Ÿ

### 4. æ¸…æ™°åˆ†ç±» (Clear Classification)
- åŒç»´åº¦åˆ†ç±» (Type + Scope) ä½¿ä»»åŠ¡å½’ç±»æ¸…æ™°
- å®¶é•¿ç«¯æŒ‰ç±»åž‹åˆ†ç»„ï¼Œä¾¿äºŽå¿«é€Ÿè®°å½•
- å­©å­ç«¯æŒ‰å½’å±žåˆ†ç»„ï¼Œä¾¿äºŽç†è§£æ„ä¹‰

---

## ðŸ“ æ–‡ä»¶æ¸…å• | File List

### æ–°å»ºæ–‡ä»¶ (New Files)
1. `supabase/migrations/20250102000000_add_quest_type_scope.sql`
2. `supabase/migrations/20250102000001_update_seed_templates.sql`
3. `types/quest.ts`

### ä¿®æ”¹æ–‡ä»¶ (Modified Files)
1. `types/database.ts` - æ›´æ–° quests è¡¨ç±»åž‹å®šä¹‰
2. `app/[locale]/(child)/app/quests/page.tsx` - åªæŸ¥è¯¢ bonus quests
3. `components/child/QuestGrid.tsx` - æŒ‰ scope åˆ†ç»„å±•ç¤º
4. `components/admin/QuickRecordForm.tsx` - æŒ‰ type åˆ†ç»„å±•ç¤º
5. `messages/en.json` - æ·»åŠ  hygiene, social ç±»åˆ«
6. `messages/zh-CN.json` - æ·»åŠ å«ç”Ÿã€ç¤¾äº¤ç±»åˆ«

### æœªæ”¹åŠ¨ä½†ç›¸å…³çš„æ–‡ä»¶ (Related but Unchanged)
1. `components/admin/StarRequestList.tsx` - ä½¿ç”¨ quest æ•°æ®
2. `components/child/RequestStarsModal.tsx` - æäº¤ bonus quest ç”³è¯·
3. `app/[locale]/(parent)/admin/record/page.tsx` - å¿«é€Ÿè®°å½•é¡µé¢å…¥å£

---

## ðŸ§ª æµ‹è¯•è¦ç‚¹ | Testing Checklist

### æ•°æ®åº“å±‚é¢
- [ ] è¿è¡Œè¿ç§»è„šæœ¬ï¼Œç¡®è®¤å­—æ®µæ·»åŠ æˆåŠŸ
- [ ] åˆ›å»ºæ–°å®¶åº­ï¼ŒéªŒè¯seed dataæ­£ç¡®æ’å…¥
- [ ] æ£€æŸ¥ç´¢å¼•æ˜¯å¦åˆ›å»ºæˆåŠŸ
- [ ] éªŒè¯çŽ°æœ‰æ•°æ®çš„ type è‡ªåŠ¨è®¾ç½®æ­£ç¡®

### å­©å­ç«¯
- [ ] åªæ˜¾ç¤º type='bonus' çš„ä»»åŠ¡
- [ ] æŒ‰ scope åˆ†ä¸‰ç»„å±•ç¤º (family, self, other)
- [ ] æ—  bonus quests æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
- [ ] ç±»åˆ«æ ‡ç­¾æ˜¾ç¤ºæ­£ç¡® (hygiene, social)

### å®¶é•¿ç«¯ - å¿«é€Ÿè®°å½•
- [ ] æ˜¾ç¤ºä¸‰ä¸ªä»»åŠ¡ç»„ (Bonus, Duty, Violation)
- [ ] Bonus ç»„æ˜¾ç¤ºä¸ºç»¿è‰²è¾¹æ¡†
- [ ] Duty ç»„æ˜¾ç¤ºä¸ºé»„è‰²è¾¹æ¡†
- [ ] Violation ç»„æ˜¾ç¤ºä¸ºçº¢è‰²è¾¹æ¡†
- [ ] è‡ªå®šä¹‰æè¿°åŠŸèƒ½æ­£å¸¸

### å›½é™…åŒ–
- [ ] è‹±æ–‡ç•Œé¢æ˜¾ç¤ºæ­£ç¡®
- [ ] ä¸­æ–‡ç•Œé¢æ˜¾ç¤ºæ­£ç¡®
- [ ] ç±»åˆ«æ ‡ç­¾ä¸­è‹±æ–‡åˆ‡æ¢æ­£å¸¸

---

## âš ï¸ è¿ç§»æ³¨æ„äº‹é¡¹ | Migration Notes

### å¯¹çŽ°æœ‰æ•°æ®çš„å½±å“

1. **çŽ°æœ‰ quests è¡¨æ•°æ®**:
   - `stars > 0` çš„ä»»åŠ¡ â†’ `type = 'bonus'`, `scope = 'self'`
   - `stars < 0` çš„ä»»åŠ¡ â†’ `type = 'duty'`, `scope = 'self'`
   - éœ€è¦æ‰‹åŠ¨è°ƒæ•´ä¸å‡†ç¡®çš„åˆ†ç±»

2. **å‘åŽå…¼å®¹**:
   - `is_positive` å­—æ®µä¿ç•™ï¼Œç”¨äºŽå‘åŽå…¼å®¹
   - æ–°ä»£ç ä¼˜å…ˆä½¿ç”¨ `type` å­—æ®µ
   - æ—§ä»£ç ä»å¯ä½¿ç”¨ `is_positive`

3. **æ•°æ®åº“è¿ç§»æ­¥éª¤**:
   ```bash
   # 1. åœ¨ Supabase Studio ä¸­è¿è¡Œè¿ç§»
   # 2. æ£€æŸ¥çŽ°æœ‰æ•°æ®çš„ type è®¾ç½®
   # 3. æ‰‹åŠ¨è°ƒæ•´é”™è¯¯çš„åˆ†ç±»
   # 4. (å¯é€‰) ä¸ºçŽ°æœ‰å®¶åº­æ·»åŠ æ–°æ¨¡æ¿
   ```

---

## ðŸŽ“ å®žçŽ°äº®ç‚¹ | Implementation Highlights

1. **æ¸…æ™°çš„ç±»åž‹ç³»ç»Ÿ**: åŒç»´åº¦åˆ†ç±» (Type Ã— Scope) è§£å†³äº†å¤æ‚åœºæ™¯çš„åˆ†ç±»éœ€æ±‚

2. **å­©å­ç«¯æ­£å‘ä½“éªŒ**: åªå±•ç¤º Bonus Questsï¼Œéšè— Duties å’Œ Violationsï¼Œä¿æŒæ­£å‘æ¿€åŠ±

3. **å®¶é•¿ç«¯å¿«æ·æ“ä½œ**: æŒ‰è¡Œä¸ºç±»åž‹åˆ†ç»„ï¼Œä¸€ç›®äº†ç„¶ï¼Œå¿«é€Ÿè®°å½•

4. **å®Œæ•´çš„ç±»åž‹å®‰å…¨**: æ–°å¢ž `types/quest.ts` æä¾›å®Œæ•´çš„ç±»åž‹å®šä¹‰å’Œå·¥å…·å‡½æ•°

5. **å¯æ‰©å±•æ€§**: é¢„ç•™äº† max_per_day å­—æ®µï¼Œä¸ºæœªæ¥çš„é¢‘çŽ‡é™åˆ¶åŠŸèƒ½åšå‡†å¤‡

6. **æ•°æ®å®Œæ•´æ€§**: ä½¿ç”¨ CHECK çº¦æŸç¡®ä¿ type å’Œ scope å€¼çš„æœ‰æ•ˆæ€§

---

## ðŸ“Š ä»£ç ç»Ÿè®¡ | Code Statistics

```
æ–°å¢žä»£ç è¡Œæ•°: ~600+ lines
æ–°å¢žæ–‡ä»¶: 3 files
ä¿®æ”¹æ–‡ä»¶: 6 files
æ–°å¢žç±»åž‹å®šä¹‰: 7+ types/interfaces
æ–°å¢žå‡½æ•°: 5+ utility functions
æ–°å¢ž SQL migration: 2 files
```

---

## ðŸš€ ä¸‹ä¸€æ­¥ | Next Steps

### å¾…å®ŒæˆåŠŸèƒ½ (Pending)

1. **ä»»åŠ¡ç®¡ç†é¡µé¢** (`/admin/quests`)
   - CRUD æ“ä½œ
   - æŒ‰ type+scope åˆ†ç»„å±•ç¤º
   - å¼•å¯¼å¼åˆ›å»º UI

2. **å¥–åŠ±ç®¡ç†é¡µé¢** (`/admin/rewards`)
   - CRUD æ“ä½œ
   - æŒ‰ç±»åˆ«ç®¡ç†

3. **æ•°æ®è¿ç§»è„šæœ¬**
   - ä¸ºçŽ°æœ‰å®¶åº­æ·»åŠ æ–°æ¨¡æ¿
   - æ‰¹é‡æ›´æ–°çŽ°æœ‰ä»»åŠ¡çš„åˆ†ç±»

### ä¼˜åŒ–å»ºè®® (Optimization)

1. **é¢‘çŽ‡é™åˆ¶**: å®žçŽ° max_per_day é€»è¾‘
2. **æ™ºèƒ½æŽ¨è**: æ ¹æ®æ—¶é—´å’ŒåŽ†å²è®°å½•æŽ¨èå¸¸ç”¨ä»»åŠ¡
3. **æ•°æ®åˆ†æž**: æŒ‰ type/scope ç»Ÿè®¡å­©å­çš„è¡Œä¸ºåˆ†å¸ƒ

---

## âœ… å®ŒæˆçŠ¶æ€ | Completion Status

- âœ… æ•°æ®åº“ Schema æ›´æ–°
- âœ… Seed Data æ¨¡æ¿æ›´æ–°
- âœ… TypeScript ç±»åž‹å®šä¹‰
- âœ… å­©å­ç«¯ UI æ›´æ–°
- âœ… å®¶é•¿å¿«é€Ÿè®°å½• UI æ›´æ–°
- âœ… å›½é™…åŒ–ç¿»è¯‘æ›´æ–°
- â³ ä»»åŠ¡ç®¡ç† CRUD (æœªå¼€å§‹)
- â³ å¥–åŠ±ç®¡ç† CRUD (æœªå¼€å§‹)
- â³ ç”Ÿäº§çŽ¯å¢ƒæ•°æ®è¿ç§» (å¾…è¿è¡Œ)

---

**å®žæ–½æ—¶é—´**: ~2 hours
**å½±å“èŒƒå›´**: Core quest system architecture
**ç ´åæ€§å˜æ›´**: Minimal (backward compatible with is_positive field)
**æµ‹è¯•çŠ¶æ€**: Pending manual testing

---

*å®žæ–½è€…: Claude Sonnet 4.5 | æ—¶é—´: 2025-01-02*
